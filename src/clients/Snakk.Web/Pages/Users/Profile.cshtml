@page "/u/{publicId}"
@using Snakk.Web.Helpers
@model ProfileModel
@{
    ViewData["Title"] = Model.Profile?.DisplayName ?? "User Profile";
}

<div class="max-w-4xl mx-auto">
    @if (Model.Profile != null)
    {
        <!-- Profile Header Card -->
        <div class="clean-card mb-6">
            <div class="flex flex-col sm:flex-row items-center sm:items-start gap-6 p-6">
                <div class="avatar avatar-lg">
                    <img src="@SnakkUrlHelper.UserAvatar(Model.ApiBaseUrl, Model.Profile.PublicId)"
                         alt="@Model.Profile.DisplayName"
                         class="rounded-full w-24 h-24" />
                </div>
                <div class="flex-1 text-center sm:text-left">
                    <div class="flex flex-col sm:flex-row sm:items-center gap-3 mb-2">
                        <h1 class="text-2xl font-bold">@Model.Profile.DisplayName</h1>
                        <div id="user-badges" class="flex flex-wrap gap-2 justify-center sm:justify-start">
                            <!-- Badges will be loaded here -->
                        </div>
                    </div>
                    <div class="text-muted space-y-1">
                        <p class="flex items-center justify-center sm:justify-start gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            <span>Joined @Model.FormatDate(Model.Profile.JoinedAt)</span>
                        </p>
                        @if (Model.Profile.LastSeenAt.HasValue)
                        {
                            <p class="flex items-center justify-center sm:justify-start gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span>Last seen @Model.GetRelativeTime(Model.Profile.LastSeenAt)</span>
                            </p>
                        }
                    </div>
                </div>
                <div class="flex flex-col gap-2" id="profile-actions">
                    <!-- Follow button will be loaded here -->
                    <div class="skeleton h-10 w-32"></div>
                </div>
            </div>

            <div class="divider my-0"></div>

            <!-- Stats Grid -->
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 p-6">
                <div class="text-center">
                    <div class="text-3xl font-bold text-primary">@Model.Profile.DiscussionCount</div>
                    <div class="text-sm text-muted">Discussions</div>
                </div>
                <div class="text-center">
                    <div class="text-3xl font-bold text-primary" id="stat-replies">@Model.Profile.PostCount</div>
                    <div class="text-sm text-muted">Replies</div>
                </div>
                <div class="text-center">
                    <div class="text-3xl font-bold text-accent">@(Model.Profile.DiscussionCount + Model.Profile.PostCount)</div>
                    <div class="text-sm text-muted">Total Activity</div>
                </div>
                <div class="text-center">
                    <div class="text-3xl font-bold text-secondary" id="stat-followers">
                        <div class="skeleton h-10 w-16 mx-auto"></div>
                    </div>
                    <div class="text-sm text-muted">Followers</div>
                </div>
            </div>

            <div class="divider my-0"></div>

            <!-- Activity Metrics -->
            <div class="px-6 pb-6">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div class="stat bg-base-200 rounded-lg p-4">
                        <div class="stat-title text-xs">Member for</div>
                        <div class="stat-value text-2xl">
                            @{
                                var daysSinceJoined = (DateTime.UtcNow - Model.Profile.JoinedAt).Days;
                            }
                            @daysSinceJoined days
                        </div>
                        <div class="stat-desc text-xs">
                            @{
                                var avgPerDay = daysSinceJoined > 0 ? (Model.Profile.DiscussionCount + Model.Profile.PostCount) / (double)daysSinceJoined : 0;
                            }
                            ~@avgPerDay.ToString("F1") contributions/day
                        </div>
                    </div>
                    <div class="stat bg-base-200 rounded-lg p-4">
                        <div class="stat-title text-xs">Recent Activity</div>
                        <div class="stat-value text-2xl">
                            @if (Model.Profile.LastSeenAt.HasValue)
                            {
                                @Model.GetRelativeTime(Model.Profile.LastSeenAt)
                            }
                            else
                            {
                                <span>Never</span>
                            }
                        </div>
                        <div class="stat-desc text-xs">Last seen on platform</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Activity Tabs -->
        <div class="tabs tabs-boxed mb-6">
            <a href="/u/@Model.Profile.PublicId?tab=overview"
               class="tab @(Model.Tab == "overview" ? "tab-active" : "")">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
                </svg>
                Overview
            </a>
            <a href="/u/@Model.Profile.PublicId?tab=discussions"
               class="tab @(Model.Tab == "discussions" ? "tab-active" : "")">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                </svg>
                Discussions
            </a>
            <a href="/u/@Model.Profile.PublicId?tab=posts"
               class="tab @(Model.Tab == "posts" ? "tab-active" : "")">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z" />
                </svg>
                Posts
            </a>
        </div>

        <!-- Tab Content -->
        @if (Model.Tab == "overview")
        {
            <div class="space-y-6">
                <!-- Activity Chart -->
                <div class="clean-card">
                    <div class="p-4 border-b border-subtle">
                        <div class="flex items-center justify-between">
                            <h3 class="font-semibold">Activity History</h3>
                            <div class="flex gap-2">
                                <button onclick="loadActivityChart(14)" class="btn btn-ghost btn-xs" id="chart-14">14 days</button>
                                <button onclick="loadActivityChart(30)" class="btn btn-ghost btn-xs btn-active" id="chart-30">30 days</button>
                                <button onclick="loadActivityChart(90)" class="btn btn-ghost btn-xs" id="chart-90">90 days</button>
                            </div>
                        </div>
                    </div>
                    <div id="activity-chart" class="p-6">
                        <!-- Skeleton loader -->
                        <div class="space-y-3">
                            <div class="skeleton h-48 w-full"></div>
                            <div class="flex justify-center gap-4">
                                <div class="skeleton h-4 w-24"></div>
                                <div class="skeleton h-4 w-24"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Top Contributions -->
                <div class="clean-card">
                    <div class="p-4 border-b border-subtle">
                        <h3 class="font-semibold">Top Contributions</h3>
                    </div>
                    <div id="top-contributions" class="p-4">
                        <!-- Skeleton loader -->
                        <div class="space-y-4">
                            <div class="skeleton h-14 w-full"></div>
                            <div class="skeleton h-14 w-full"></div>
                            <div class="skeleton h-14 w-full"></div>
                        </div>
                    </div>
                </div>

                <!-- Recent Discussions -->
                <div class="clean-card">
                    <div class="flex items-center justify-between p-4 border-b border-subtle">
                        <h3 class="font-semibold">Recent Discussions</h3>
                        <a href="/u/@Model.Profile.PublicId?tab=discussions" class="text-sm text-primary hover:underline">View all</a>
                    </div>
                    <div id="recent-discussions" class="p-4">
                        <!-- Skeleton loader -->
                        <div class="space-y-4">
                            <div class="skeleton h-16 w-full"></div>
                            <div class="skeleton h-16 w-full"></div>
                            <div class="skeleton h-16 w-full"></div>
                        </div>
                    </div>
                </div>

                <!-- Recent Posts -->
                <div class="clean-card">
                    <div class="flex items-center justify-between p-4 border-b border-subtle">
                        <h3 class="font-semibold">Recent Posts</h3>
                        <a href="/u/@Model.Profile.PublicId?tab=posts" class="text-sm text-primary hover:underline">View all</a>
                    </div>
                    <div id="recent-posts" class="p-4">
                        <!-- Skeleton loader -->
                        <div class="space-y-4">
                            <div class="skeleton h-20 w-full"></div>
                            <div class="skeleton h-20 w-full"></div>
                            <div class="skeleton h-20 w-full"></div>
                        </div>
                    </div>
                </div>
            </div>
        }
        else if (Model.Tab == "discussions")
        {
            <div class="clean-card">
                <div id="all-discussions" class="p-4">
                    <!-- Skeleton loader -->
                    <div class="space-y-4">
                        <div class="skeleton h-20 w-full"></div>
                        <div class="skeleton h-20 w-full"></div>
                        <div class="skeleton h-20 w-full"></div>
                        <div class="skeleton h-20 w-full"></div>
                        <div class="skeleton h-20 w-full"></div>
                    </div>
                </div>
            </div>
        }
        else if (Model.Tab == "posts")
        {
            <div class="clean-card">
                <div id="all-posts" class="p-4">
                    <!-- Skeleton loader -->
                    <div class="space-y-4">
                        <div class="skeleton h-24 w-full"></div>
                        <div class="skeleton h-24 w-full"></div>
                        <div class="skeleton h-24 w-full"></div>
                        <div class="skeleton h-24 w-full"></div>
                        <div class="skeleton h-24 w-full"></div>
                    </div>
                </div>
            </div>
        }
    }
</div>

@section Scripts {
    <script>
        const apiBaseUrl = '@Model.ApiBaseUrl';
        const userId = '@Model.Profile?.PublicId';
        const currentTab = '@Model.Tab';

        // Load user stats
        async function loadUserStats() {
            try {
                const response = await fetch(`${apiBaseUrl}/users/${userId}/stats`);
                const data = await response.json();

                const followerStat = document.getElementById('stat-followers');
                if (followerStat) {
                    followerStat.textContent = data.followerCount || 0;
                }

                const replyStat = document.getElementById('stat-replies');
                if (replyStat && data.replyCount !== undefined) {
                    replyStat.textContent = data.replyCount;
                }
            } catch (error) {
                console.error('Error loading user stats:', error);
                const followerStat = document.getElementById('stat-followers');
                if (followerStat) {
                    followerStat.textContent = '0';
                }
            }
        }

        async function loadRecentDiscussions(limit = 5) {
            const container = document.getElementById('recent-discussions');
            if (!container) return;

            try {
                const response = await fetch(`${apiBaseUrl}/search/discussions?authorPublicId=${userId}&pageSize=${limit}`);
                const data = await response.json();

                if (!data.items || data.items.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-muted mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                            </svg>
                            <p class="text-muted">No discussions started yet</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = data.items.map(d => `
                    <a href="${getDiscussionUrl(d)}" class="block p-3 hover:bg-subtle rounded-lg transition-colors">
                        <div class="font-medium mb-1">${escapeHtml(d.title)}</div>
                        <div class="text-sm text-muted flex items-center gap-2">
                            <span>${escapeHtml(d.spaceName)}</span>
                            <span>Â·</span>
                            <span>${formatTimeAgo(d.createdAt)}</span>
                            <span>Â·</span>
                            <span>${d.postCount} ${d.postCount === 1 ? 'reply' : 'replies'}</span>
                        </div>
                    </a>
                `).join('');
            } catch (error) {
                console.error('Error loading discussions:', error);
                container.innerHTML = '<div class="text-center py-4 text-error">Failed to load discussions</div>';
            }
        }

        async function loadRecentPosts(limit = 5) {
            const container = document.getElementById('recent-posts');
            if (!container) return;

            try {
                const response = await fetch(`${apiBaseUrl}/search/posts?authorPublicId=${userId}&pageSize=${limit}`);
                const data = await response.json();

                if (!data.items || data.items.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-muted mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z" />
                            </svg>
                            <p class="text-muted">No posts yet</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = data.items.map(p => `
                    <div class="p-3 border-b border-subtle last:border-0">
                        <div class="text-sm text-muted mb-2">
                            <a href="${getDiscussionUrl(p)}" class="hover:underline">${escapeHtml(p.discussionTitle)}</a>
                            <span class="mx-1">Â·</span>
                            <span>${formatTimeAgo(p.createdAt)}</span>
                        </div>
                        <div class="prose prose-sm max-w-none line-clamp-3">${escapeHtml(p.content)}</div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading posts:', error);
                container.innerHTML = '<div class="text-center py-4 text-error">Failed to load posts</div>';
            }
        }

        async function loadAllDiscussions() {
            const container = document.getElementById('all-discussions');
            if (!container) return;

            try {
                const response = await fetch(`${apiBaseUrl}/search/discussions?authorPublicId=${userId}&pageSize=20`);
                const data = await response.json();

                if (!data.items || data.items.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-12">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-muted mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                            </svg>
                            <h3 class="font-semibold mb-2">No discussions yet</h3>
                            <p class="text-sm text-muted">This user hasn't started any discussions</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = data.items.map(d => `
                    <a href="${getDiscussionUrl(d)}" class="block p-4 hover:bg-subtle rounded-lg transition-colors border-b border-subtle last:border-0">
                        <div class="font-medium mb-2">${escapeHtml(d.title)}</div>
                        <div class="text-sm text-muted flex flex-wrap items-center gap-2">
                            <span>${escapeHtml(d.spaceName)}</span>
                            <span>Â·</span>
                            <span>${formatTimeAgo(d.createdAt)}</span>
                            <span>Â·</span>
                            <span>${d.postCount} ${d.postCount === 1 ? 'reply' : 'replies'}</span>
                            <span>Â·</span>
                            <span>${d.reactionCount} ${d.reactionCount === 1 ? 'reaction' : 'reactions'}</span>
                        </div>
                    </a>
                `).join('');
            } catch (error) {
                console.error('Error loading discussions:', error);
                container.innerHTML = '<div class="text-center py-8 text-error">Failed to load discussions</div>';
            }
        }

        async function loadAllPosts() {
            const container = document.getElementById('all-posts');
            if (!container) return;

            try {
                const response = await fetch(`${apiBaseUrl}/search/posts?authorPublicId=${userId}&pageSize=20`);
                const data = await response.json();

                if (!data.items || data.items.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-12">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-muted mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z" />
                            </svg>
                            <h3 class="font-semibold mb-2">No posts yet</h3>
                            <p class="text-sm text-muted">This user hasn't posted any replies</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = data.items.map(p => `
                    <div class="p-4 border-b border-subtle last:border-0">
                        <div class="text-sm text-muted mb-2 flex items-center gap-2">
                            <span>In</span>
                            <a href="${getDiscussionUrl(p)}" class="font-medium hover:underline">${escapeHtml(p.discussionTitle)}</a>
                            <span>Â·</span>
                            <span>${formatTimeAgo(p.createdAt)}</span>
                        </div>
                        <div class="prose prose-sm max-w-none">${escapeHtml(p.content)}</div>
                        <div class="mt-2">
                            <a href="${getDiscussionUrl(p)}" class="text-sm text-primary hover:underline">View in discussion â†’</a>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading posts:', error);
                container.innerHTML = '<div class="text-center py-8 text-error">Failed to load posts</div>';
            }
        }

        function getDiscussionUrl(item) {
            const hubSlug = item.hubSlug || 'h';
            const spaceSlug = item.spaceSlug || 's';
            const discussionSlug = item.discussionSlug || item.slug || 'd';
            const discussionId = item.discussionPublicId || item.publicId;
            return `/h/${hubSlug}/${spaceSlug}/${discussionSlug}~${discussionId}`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            if (diffDays < 30) return `${Math.floor(diffDays / 7)}w ago`;
            return date.toLocaleDateString();
        }

        // Activity Chart
        let currentChartDays = 30;

        async function loadActivityChart(days) {
            currentChartDays = days;

            // Update button states
            ['14', '30', '90'].forEach(d => {
                const btn = document.getElementById(`chart-${d}`);
                if (btn) {
                    if (d === days.toString()) {
                        btn.classList.add('btn-active');
                    } else {
                        btn.classList.remove('btn-active');
                    }
                }
            });

            const container = document.getElementById('activity-chart');
            if (!container) return;

            try {
                const response = await fetch(`${apiBaseUrl}/users/${userId}/activity-history?days=${days}`);
                const result = await response.json();

                renderActivityChart(container, result.data, days);
            } catch (error) {
                console.error('Error loading activity chart:', error);
                container.innerHTML = '<div class="text-center py-8 text-error">Failed to load activity chart</div>';
            }
        }

        function renderActivityChart(container, data, days) {
            if (!data || data.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-muted mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                        </svg>
                        <h3 class="font-semibold mb-2">No activity yet</h3>
                        <p class="text-sm text-muted">Activity will appear here once this user starts contributing</p>
                    </div>
                `;
                return;
            }

            // Calculate max value for scaling
            const maxValue = Math.max(...data.map(d => d.total), 1);
            const maxHeight = 150; // pixels

            // Group by week for better visualization if > 30 days
            const shouldGroupByWeek = days > 30;
            let chartData = data;

            if (shouldGroupByWeek) {
                const grouped = [];
                for (let i = 0; i < data.length; i += 7) {
                    const week = data.slice(i, i + 7);
                    const weekTotal = {
                        date: week[0].date,
                        discussions: week.reduce((sum, d) => sum + d.discussions, 0),
                        posts: week.reduce((sum, d) => sum + d.posts, 0),
                        total: week.reduce((sum, d) => sum + d.total, 0),
                        isWeek: true
                    };
                    grouped.push(weekTotal);
                }
                chartData = grouped;
            }

            const barsHtml = chartData.map((day, index) => {
                const heightPercent = maxValue > 0 ? (day.total / maxValue) * 100 : 0;
                const discussionsPercent = day.total > 0 ? (day.discussions / day.total) * 100 : 0;
                const postsPercent = day.total > 0 ? (day.posts / day.total) * 100 : 0;

                const dateLabel = shouldGroupByWeek
                    ? `Week of ${new Date(day.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`
                    : new Date(day.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

                return `
                    <div class="flex flex-col items-center gap-2" style="flex: 1; min-width: 0;">
                        <div class="relative w-full flex flex-col justify-end items-center" style="height: ${maxHeight}px;">
                            <div class="w-full max-w-[20px] flex flex-col justify-end rounded-t transition-all hover:opacity-80"
                                 style="height: ${heightPercent}%;"
                                 title="${day.total} contribution${day.total !== 1 ? 's' : ''}\n${day.discussions} discussion${day.discussions !== 1 ? 's' : ''}\n${day.posts} post${day.posts !== 1 ? 's' : ''}\n${dateLabel}">
                                ${day.discussions > 0 ? `<div class="bg-primary" style="height: ${discussionsPercent}%;"></div>` : ''}
                                ${day.posts > 0 ? `<div class="bg-secondary" style="height: ${postsPercent}%;"></div>` : ''}
                                ${day.total === 0 ? '<div class="bg-base-300 h-1"></div>' : ''}
                            </div>
                        </div>
                        ${(shouldGroupByWeek || days <= 14 || index % Math.ceil(data.length / 10) === 0) ?
                            `<div class="text-xs text-muted text-center" style="writing-mode: ${days > 30 ? 'horizontal-tb' : 'horizontal-tb'}; transform: rotate(${days > 30 ? '0deg' : '-45deg'}); transform-origin: center; font-size: 0.65rem;">${new Date(day.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</div>`
                            : ''}
                    </div>
                `;
            }).join('');

            const totalDiscussions = data.reduce((sum, d) => sum + d.discussions, 0);
            const totalPosts = data.reduce((sum, d) => sum + d.posts, 0);
            const totalActivity = totalDiscussions + totalPosts;

            container.innerHTML = `
                <div class="space-y-4">
                    <div class="flex gap-1 items-end justify-center" style="height: ${maxHeight + 40}px; overflow-x: auto;">
                        ${barsHtml}
                    </div>
                    <div class="flex justify-center gap-6 text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-4 h-4 bg-primary rounded"></div>
                            <span>${totalDiscussions} discussions</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-4 h-4 bg-secondary rounded"></div>
                            <span>${totalPosts} posts</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-4 h-4 bg-accent rounded"></div>
                            <span>${totalActivity} total</span>
                        </div>
                    </div>
                </div>
            `;
        }

        // Profile Actions (Follow button)
        async function loadProfileActions() {
            const container = document.getElementById('profile-actions');
            if (!container) return;

            try {
                // Check if user is authenticated and viewing someone else's profile
                const authResponse = await fetch(`${apiBaseUrl}/auth/status`, { credentials: 'include' });
                const authData = await authResponse.json();

                if (!authData.isAuthenticated) {
                    container.innerHTML = ''; // No actions for anonymous users
                    return;
                }

                if (authData.publicId === userId) {
                    // Viewing own profile
                    container.innerHTML = `
                        <a href="/auth/profile" class="btn btn-outline btn-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                            </svg>
                            Edit Profile
                        </a>
                    `;
                    return;
                }

                // Check follow status
                const followResponse = await fetch(`${apiBaseUrl}/users/${userId}/follow-status?currentUserId=${authData.publicId}`, {
                    credentials: 'include'
                });
                const followData = await followResponse.json();

                container.innerHTML = `
                    <button onclick="toggleFollowUser()" class="btn ${followData.isFollowing ? 'btn-outline' : 'btn-primary'} btn-sm" id="follow-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${followData.isFollowing ? 'M5 13l4 4L19 7' : 'M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z'}" />
                        </svg>
                        <span id="follow-btn-text">${followData.isFollowing ? 'Following' : 'Follow'}</span>
                    </button>
                `;
            } catch (error) {
                console.error('Error loading profile actions:', error);
                container.innerHTML = '';
            }
        }

        async function toggleFollowUser() {
            const btn = document.getElementById('follow-btn');
            const btnText = document.getElementById('follow-btn-text');
            if (!btn || !btnText) return;

            const wasFollowing = btnText.textContent === 'Following';
            btn.disabled = true;

            try {
                const response = await fetch(`${apiBaseUrl}/users/${userId}/follow`, {
                    method: 'POST',
                    credentials: 'include'
                });

                if (response.ok) {
                    const result = await response.json();
                    btnText.textContent = result.isFollowing ? 'Following' : 'Follow';

                    if (result.isFollowing) {
                        btn.classList.remove('btn-primary');
                        btn.classList.add('btn-outline');
                    } else {
                        btn.classList.remove('btn-outline');
                        btn.classList.add('btn-primary');
                    }

                    // Update follower count
                    loadUserStats();
                } else {
                    throw new Error('Failed to toggle follow');
                }
            } catch (error) {
                console.error('Error toggling follow:', error);
                alert('Failed to update follow status');
            } finally {
                btn.disabled = false;
            }
        }

        // Generate badges based on activity
        function loadUserBadges() {
            const container = document.getElementById('user-badges');
            if (!container) return;

            const badges = [];
            const totalActivity = @Model.Profile.DiscussionCount + @Model.Profile.PostCount;
            const daysSinceJoined = @((DateTime.UtcNow - Model.Profile.JoinedAt).Days);

            // Activity level badges
            if (totalActivity >= 1000) {
                badges.push({ text: 'ðŸ† Power User', color: 'badge-warning', title: '1000+ contributions' });
            } else if (totalActivity >= 500) {
                badges.push({ text: 'â­ Super Contributor', color: 'badge-info', title: '500+ contributions' });
            } else if (totalActivity >= 100) {
                badges.push({ text: 'âœ¨ Active Member', color: 'badge-success', title: '100+ contributions' });
            }

            // Discussion starter badge
            if (@Model.Profile.DiscussionCount >= 50) {
                badges.push({ text: 'ðŸ’¬ Discussion Starter', color: 'badge-primary', title: '50+ discussions' });
            }

            // Engagement badge (lots of posts relative to discussions)
            if (@Model.Profile.PostCount >= 100 && @Model.Profile.PostCount > @Model.Profile.DiscussionCount * 3) {
                badges.push({ text: 'ðŸ—£ï¸ Conversationalist', color: 'badge-accent', title: 'Highly engaged in discussions' });
            }

            // Veteran badge
            if (daysSinceJoined >= 365) {
                badges.push({ text: 'ðŸŽ–ï¸ Veteran', color: 'badge-secondary', title: 'Member for over a year' });
            } else if (daysSinceJoined >= 180) {
                badges.push({ text: 'ðŸ“… Regular', color: 'badge-neutral', title: 'Member for 6+ months' });
            }

            if (badges.length > 0) {
                container.innerHTML = badges.map(badge =>
                    `<div class="badge ${badge.color} badge-sm" title="${badge.title}">${badge.text}</div>`
                ).join('');
            }
        }

        // Load top contributions
        async function loadTopContributions() {
            const container = document.getElementById('top-contributions');
            if (!container) return;

            try {
                const response = await fetch(`${apiBaseUrl}/search/discussions?authorPublicId=${userId}&pageSize=3`);
                const data = await response.json();

                if (!data.items || data.items.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-muted mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
                            </svg>
                            <p class="text-muted">No popular discussions yet</p>
                        </div>
                    `;
                    return;
                }

                // Sort by reaction count to get most popular
                const sortedDiscussions = data.items.sort((a, b) => b.reactionCount - a.reactionCount).slice(0, 3);

                container.innerHTML = sortedDiscussions.map(d => `
                    <a href="${getDiscussionUrl(d)}" class="block p-3 hover:bg-subtle rounded-lg transition-colors border border-subtle">
                        <div class="flex items-start gap-3">
                            <div class="flex-1 min-w-0">
                                <div class="font-medium mb-1 truncate">${escapeHtml(d.title)}</div>
                                <div class="text-sm text-muted flex items-center gap-3">
                                    <span class="flex items-center gap-1">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                                        </svg>
                                        ${d.reactionCount}
                                    </span>
                                    <span class="flex items-center gap-1">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                                        </svg>
                                        ${d.postCount}
                                    </span>
                                    <span class="text-xs">${escapeHtml(d.spaceName)}</span>
                                </div>
                            </div>
                        </div>
                    </a>
                `).join('');
            } catch (error) {
                console.error('Error loading top contributions:', error);
                container.innerHTML = '<div class="text-center py-4 text-error">Failed to load top contributions</div>';
            }
        }

        // Load user stats immediately
        loadUserStats();
        loadProfileActions();
        loadUserBadges();

        // Load content based on current tab
        if (currentTab === 'overview') {
            loadActivityChart(30);
            loadTopContributions();
            loadRecentDiscussions(5);
            loadRecentPosts(5);
        } else if (currentTab === 'discussions') {
            loadAllDiscussions();
        } else if (currentTab === 'posts') {
            loadAllPosts();
        }
    </script>
}
