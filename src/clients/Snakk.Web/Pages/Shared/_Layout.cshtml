@inject Microsoft.Extensions.Configuration.IConfiguration Configuration
@inject Snakk.Web.Services.ICommunityContext CommunityContext
@inject IHttpContextAccessor HttpContextAccessor
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Snakk</title>

    <!-- SEO Meta Tags -->
    @await RenderSectionAsync("Meta", required: false)

    <!-- Canonical URL -->
    <link rel="canonical" href="@($"{Context.Request.Scheme}://{Context.Request.Host}{Context.Request.Path}{Context.Request.QueryString}")" />

    <!-- Theme Management (load early to prevent flash) -->
    <script src="~/js/theme.js" asp-append-version="true"></script>

    <!-- Tailwind CSS + daisyUI (locally compiled) -->
    <link href="~/css/tailwind.css" rel="stylesheet" asp-append-version="true" />

    <!-- HTMX -->
    <script src="~/js/htmx.min.js" asp-append-version="true"></script>
    @* INLINE REASON: HTMX framework integration that must run in <head> before page renders.
       This is tiny (10 lines) and must execute immediately to handle SPA-style navigation.
       Extracting would add HTTP overhead for minimal code. *@
    <script>
        // Update page title after HTMX content swap
        document.addEventListener('htmx:afterSwap', function(evt) {
            if (evt.detail.target.id === 'main-content') {
                const titleEl = document.getElementById('page-title');
                if (titleEl && titleEl.dataset.title) {
                    document.title = titleEl.dataset.title;
                }
            }
        });
    </script>

    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    @await RenderSectionAsync("Styles", required: false)
    <!-- JWT Auth -->
    <script src="~/js/auth.js" asp-append-version="true"></script>

    <!-- Set API URL globally for use by auth-navbar, realtime, and other modules -->
    <script>
        window.apiBaseUrl = '@(Configuration["ApiBaseUrl"] ?? "https://localhost:7291")';
        window.snakkApiBaseUrl = window.apiBaseUrl; // Alias for compatibility
    </script>
</head>
<body class="antialiased" hx-boost="true" hx-target="#main-content" hx-swap="innerHTML show:window:top" hx-push-url="true">
    @if (Configuration.GetValue<bool>("Debug:ShowCommunityDebugPane", true))
    {
        var host = HttpContextAccessor.HttpContext?.Request.Host.ToString() ?? "unknown";
        <div class="bg-gray-800 text-white text-xs px-4 py-1.5 flex items-center gap-6 font-mono flex-wrap">
            <span class="text-gray-400">DEBUG</span>
            <span>
                <span class="text-gray-400">Host:</span>
                <span class="text-yellow-300">@host</span>
            </span>
            <span>
                <span class="text-gray-400">Community:</span>
                <span class="text-green-300">@(CommunityContext.CommunitySlug ?? "null")</span>
                @if (CommunityContext.CommunityName != null)
                {
                    <span class="text-gray-500">(@CommunityContext.CommunityName)</span>
                }
            </span>
            <span>
                <span class="text-gray-400">IsDefault:</span>
                <span class="@(CommunityContext.IsDefaultCommunity ? "text-green-300" : "text-orange-300")">@CommunityContext.IsDefaultCommunity</span>
            </span>
            <span>
                <span class="text-gray-400">IsCustomDomain:</span>
                <span class="@(CommunityContext.IsCustomDomain ? "text-cyan-300" : "text-gray-500")">@CommunityContext.IsCustomDomain</span>
            </span>
            <span>
                <span class="text-gray-400">Path:</span>
                <span class="text-purple-300">@HttpContextAccessor.HttpContext?.Request.Path</span>
            </span>
            <span id="debug-auth-info">
                <span class="text-gray-400">Auth:</span>
                <span class="text-gray-500">loading...</span>
            </span>
        </div>
    }
    <nav class="navbar minimal-nav sticky top-0 z-50">
        <div class="container mx-auto px-4 lg:px-8 flex items-center gap-4">
            <!-- Brand -->
            <a class="brand-text" href="/" hx-boost="false">@(CommunityContext.IsCustomDomain && CommunityContext.CommunityName != null ? CommunityContext.CommunityName : "Snakk")</a>

            <!-- Desktop Search -->
            <form method="get" action="/search" class="hidden sm:flex items-center gap-1 flex-1 max-w-md" hx-boost="false" id="search-form">
                <div class="relative flex-1" id="search-wrapper">
                    <button type="submit" class="absolute left-1 top-1/2 -translate-y-1/2 btn btn-ghost btn-xs btn-circle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </button>
                    <input type="text"
                           id="search-input"
                           name="q"
                           placeholder="Search..."
                           class="input input-bordered input-sm w-full pl-8"
                           autocomplete="off" />

                    <!-- Search Focus Pane -->
                    <div id="search-focus-pane" class="search-focus-pane hidden">
                        <div class="p-4 space-y-4">
                            <!-- Search Type -->
                            <div>
                                <label class="text-sm font-medium mb-2 block">Search Type</label>
                                <div class="join flex-wrap">
                                    <input class="join-item btn btn-sm" type="radio" name="search-type" aria-label="Post" checked />
                                    <input class="join-item btn btn-sm" type="radio" name="search-type" aria-label="Discussion" />
                                    <input class="join-item btn btn-sm" type="radio" name="search-type" aria-label="Space" />
                                    <input class="join-item btn btn-sm" type="radio" name="search-type" aria-label="User" />
                                </div>
                            </div>

                            <!-- Date Range -->
                            <div>
                                <label class="text-sm font-medium mb-2 block">Date Range</label>
                                <div class="join flex-wrap">
                                    <input class="join-item btn btn-sm" type="radio" name="date-range" aria-label="Today" checked />
                                    <input class="join-item btn btn-sm" type="radio" name="date-range" aria-label="Past hour" />
                                    <input class="join-item btn btn-sm" type="radio" name="date-range" aria-label="Past week" />
                                    <input class="join-item btn btn-sm" type="radio" name="date-range" aria-label="Past month" />
                                    <input class="join-item btn btn-sm" type="radio" name="date-range" aria-label="Past year" />
                                    <input class="join-item btn btn-sm" type="radio" name="date-range" aria-label="All time" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>

            <!-- Right: Mobile Search + Auth -->
            <div class="flex items-center gap-2 ml-auto">
                <!-- Mobile Search Icon -->
                <a href="/search" class="btn btn-ghost btn-sm btn-square sm:hidden" title="Search">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </a>
                <div id="auth-nav">
                    <!-- Auth UI will be loaded here -->
                </div>
            </div>
        </div>
    </nav>

    <script src="~/js/auth-navbar.js" asp-append-version="true"></script>
    <script src="~/js/search-focus.js" asp-append-version="true"></script>

    <main id="main-content" class="container mx-auto px-4 py-8">
        <div id="page-title" data-title="@ViewData["Title"] - Snakk" class="hidden"></div>
        @RenderBody()
    </main>

    <footer class="footer footer-center py-6 text-muted mt-16">
    </footer>

    <!-- SignalR Client (local copy) -->
    <script src="~/js/signalr.min.js" asp-append-version="true"></script>

    <!-- Site JavaScript (hover popups, etc.) -->
    <script src="~/js/site.js" asp-append-version="true"></script>

    <!-- Realtime Updates -->
    <script src="~/js/realtime.js" asp-append-version="true"></script>

    <!-- Sidebar Scrollbar Detection -->
    <script src="~/js/sidebar-scrollbar.js" asp-append-version="true"></script>

    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>
