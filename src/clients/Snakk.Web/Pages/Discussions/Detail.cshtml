@page "/h/{hubSlug}/{spaceSlug}/{slugWithId}"
@using Snakk.Web.Helpers
@using Snakk.Web.Services
@model Snakk.Web.Pages.Discussions.DetailModel
@{
    ViewData["Title"] = Model.Discussion?.Title ?? "Discussion";
}

@section Meta {
    @if (Model.Discussion != null)
    {
        var scheme = ViewContext.HttpContext.Request.Scheme;
        var host = ViewContext.HttpContext.Request.Host.ToString();
        var path = ViewContext.HttpContext.Request.Path.ToString();

        var firstPost = Model.Posts?.Items?.FirstOrDefault();
        var description = firstPost != null
            ? (firstPost.Content.Length > 160 ? firstPost.Content.Substring(0, 157) + "..." : firstPost.Content)
            : Model.Discussion.Title;
        var url = $"{scheme}://{host}{path}";
        var authorAvatar = firstPost?.Author?.AvatarUrl;
        var baseUrl = $"{scheme}://{host}";

        <meta name="description" content="@description" />

        <!-- Open Graph -->
        <meta property="og:title" content="@Model.Discussion.Title" />
        <meta property="og:description" content="@description" />
        <meta property="og:type" content="article" />
        <meta property="og:url" content="@url" />
        @if (!string.IsNullOrEmpty(authorAvatar))
        {
            <meta property="og:image" content="@($"{baseUrl}{authorAvatar}")" />
        }
        <meta property="article:published_time" content="@Model.Discussion.CreatedAt.ToString("O")" />
        <meta property="article:author" content="@(firstPost?.Author?.DisplayName ?? "Anonymous")" />

        <!-- Twitter Card -->
        <meta name="twitter:card" content="summary" />
        <meta name="twitter:title" content="@Model.Discussion.Title" />
        <meta name="twitter:description" content="@description" />
        @if (!string.IsNullOrEmpty(authorAvatar))
        {
            <meta name="twitter:image" content="@($"{baseUrl}{authorAvatar}")" />
        }

        <!-- JSON-LD Structured Data -->
        <script type="application/ld+json">
        {
            "@@context": "https://schema.org",
            "@@type": "DiscussionForumPosting",
            "headline": "@Model.Discussion.Title",
            "url": "@url",
            "datePublished": "@Model.Discussion.CreatedAt.ToString("O")",
            "author": {
                "@@type": "Person",
                "name": "@(firstPost?.Author?.DisplayName ?? "Anonymous")"
            },
            "interactionStatistic": {
                "@@type": "InteractionCounter",
                "interactionType": "https://schema.org/CommentAction",
                "userInteractionCount": @(Model.Discussion.PostCount)
            },
            "isPartOf": {
                "@@type": "WebPage",
                "name": "@(Model.Space?.Name ?? Model.SpaceSlug)"
            }
        }
        </script>

        <!-- Breadcrumb Schema -->
        <script type="application/ld+json">
        {
            "@@context": "https://schema.org",
            "@@type": "BreadcrumbList",
            "itemListElement": [
                {
                    "@@type": "ListItem",
                    "position": 1,
                    "name": "Home",
                    "item": "@($"{baseUrl}/")"
                },
                {
                    "@@type": "ListItem",
                    "position": 2,
                    "name": "Hubs",
                    "item": "@($"{baseUrl}/hubs")"
                },
                {
                    "@@type": "ListItem",
                    "position": 3,
                    "name": "@(Model.Hub?.Name ?? Model.HubSlug)",
                    "item": "@($"{baseUrl}{SnakkUrlHelper.Hub(Model.Community, Model.HubSlug)}")"
                },
                {
                    "@@type": "ListItem",
                    "position": 4,
                    "name": "@(Model.Space?.Name ?? Model.SpaceSlug)",
                    "item": "@($"{baseUrl}{SnakkUrlHelper.Space(Model.Community, Model.HubSlug, Model.SpaceSlug)}")"
                },
                {
                    "@@type": "ListItem",
                    "position": 5,
                    "name": "@Model.Discussion.Title"
                }
            ]
        }
        </script>
    }
}

@if (Model.Discussion != null)
{
    <!-- Breadcrumb -->
    <div class="max-w-6xl mx-auto">
        <nav class="breadcrumb" aria-label="Breadcrumb">
            <ol class="breadcrumb-list" itemscope itemtype="https://schema.org/BreadcrumbList">
                <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
                    <a href="/" itemprop="item" hx-boost="false">
                        <span itemprop="name">Home</span>
                    </a>
                    <meta itemprop="position" content="1" />
                </li>
                @if (Model.ShowCommunityInBreadcrumb)
                {
                    <li class="breadcrumb-separator" aria-hidden="true">/</li>
                    <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
                        <a href="/communities" itemprop="item" hx-boost="false">
                            <span itemprop="name">Communities</span>
                        </a>
                        <meta itemprop="position" content="2" />
                    </li>
                    <li class="breadcrumb-separator" aria-hidden="true">/</li>
                    <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
                        <a href="/c/@Model.Community.CommunitySlug" itemprop="item" hx-boost="false">
                            <span itemprop="name">@(Model.Community.CommunityName ?? Model.Community.CommunitySlug)</span>
                        </a>
                        <meta itemprop="position" content="3" />
                    </li>
                }
                <li class="breadcrumb-separator" aria-hidden="true">/</li>
                <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
                    <a href="/hubs" itemprop="item" hx-boost="false">
                        <span itemprop="name">Hubs</span>
                    </a>
                    <meta itemprop="position" content="@(Model.ShowCommunityInBreadcrumb ? 4 : 2)" />
                </li>
                <li class="breadcrumb-separator" aria-hidden="true">/</li>
                <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
                    <a href="@SnakkUrlHelper.Hub(Model.Community, Model.HubSlug)"
                       itemprop="item"
                                             data-popup-type="hub"
                       data-popup-id="@Model.Hub?.PublicId"
                       data-popup-name="@Model.Hub?.Name">
                        <span itemprop="name">@(Model.Hub?.Name ?? Model.HubSlug)</span>
                    </a>
                    <meta itemprop="position" content="@(Model.ShowCommunityInBreadcrumb ? 5 : 3)" />
                </li>
                <li class="breadcrumb-separator" aria-hidden="true">/</li>
                <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
                    <a href="@SnakkUrlHelper.Space(Model.Community, Model.HubSlug, Model.SpaceSlug)"
                       itemprop="item"
                                             data-popup-type="space"
                       data-popup-id="@Model.Space?.PublicId"
                       data-popup-name="@Model.Space?.Name">
                        <span itemprop="name">@(Model.Space?.Name ?? Model.SpaceSlug)</span>
                    </a>
                    <meta itemprop="position" content="@(Model.ShowCommunityInBreadcrumb ? 6 : 4)" />
                </li>
                <li class="breadcrumb-separator" aria-hidden="true">/</li>
                <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
                    <span class="breadcrumb-current truncate max-w-xs"
                          data-popup-type="discussion"
                          data-popup-id="@Model.Discussion.PublicId"
                          data-popup-name="@Model.Discussion.Title"
                          itemprop="name">@Model.Discussion.Title</span>
                    <meta itemprop="position" content="@(Model.ShowCommunityInBreadcrumb ? 7 : 5)" />
                </li>
            </ol>
        </nav>
    </div>

    <!-- Thread Header -->
    <div class="max-w-6xl mx-auto">
        <header class="discussion-header">
            <div class="flex items-start justify-between">
                <div>
                    <h1 class="title">@Model.Discussion.Title</h1>
                    <div class="meta flex items-center gap-2">
                        <time datetime="@Model.Discussion.CreatedAt.ToString("O")">
                            @Model.Discussion.CreatedAt.ToString("MMMM d, yyyy")
                        </time>
                        @if (Model.Discussion.IsPinned)
                        {
                            <span class="badge badge-primary-subtle badge-sm">Pinned</span>
                        }
                        @if (Model.Discussion.IsLocked)
                        {
                            <span class="badge badge-warning-subtle badge-sm">Locked</span>
                        }
                    </div>
                </div>
                @if (Model.IsAuthenticated)
                {
                    <div class="flex items-center gap-2">
                        <button id="follow-btn"
                                onclick="toggleFollowDiscussion('@Model.Discussion.PublicId')"
                                class="btn btn-ghost btn-sm follow-btn"
                                aria-label="Follow this discussion">
                            <svg id="follow-icon" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                            </svg>
                            <span id="follow-text">Follow</span>
                        </button>
                        <!-- Discussion actions dropdown -->
                        <div class="dropdown dropdown-end">
                            <button tabindex="0" class="btn btn-ghost btn-sm btn-square" aria-label="Discussion options">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
                                </svg>
                            </button>
                            <ul tabindex="0" class="dropdown-content menu p-1 shadow-lg bg-white border border-subtle rounded-lg w-48 z-20">
                                <li>
                                    <button id="mute-discussion-btn" onclick="toggleMuteDiscussion('@Model.Discussion.PublicId')" class="text-sm">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2" />
                                        </svg>
                                        <span id="mute-text">Mute discussion</span>
                                    </button>
                                </li>
                                <li>
                                    <button onclick="openReportModal('discussion', '@Model.Discussion.PublicId', '@Model.EscapeForJs(Model.Discussion.Title)')" class="text-sm text-error">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                        </svg>
                                        Report
                                    </button>
                                </li>
                            </ul>
                        </div>
                    </div>
                }
            </div>
        </header>
    </div>

    <!-- Jump to Unread Button -->
    <div id="jump-to-unread" class="hidden fixed bottom-6 right-6 z-30">
        <button onclick="jumpToUnread()" class="btn btn-primary btn-sm">
            Jump to unread
        </button>
    </div>

    <!-- Locked Thread Banner -->
    @if (Model.Discussion.IsLocked)
    {
        <div class="max-w-6xl mx-auto mb-4">
            <div class="bg-warning/10 border-l-4 border-warning px-4 py-3 rounded">
                <div class="flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-warning" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                    </svg>
                    <p class="text-sm font-medium text-warning-content">
                        This discussion has been locked. No new replies can be posted.
                    </p>
                </div>
            </div>
        </div>
    }

    <!-- Posts Container -->
    <div id="posts-container" class="max-w-6xl mx-auto">
        @if (Model.Posts != null && Model.Posts.Items.Any())
        {
            var postList = Model.Posts.Items.ToList();
            string? previousAuthorId = null;

            @for (int i = 0; i < postList.Count; i++)
            {
                var post = postList[i];
                var isFirstInThread = i == 0;
                var isSameAuthorAsPrevious = previousAuthorId == post.Author.PublicId && !isFirstInThread;
                var isOP = post.IsFirstPost;
                var hasReplyTo = post.ReplyTo != null;
                var isModerator = post.Author.Role == "mod" || post.Author.Role == "admin";

                <!-- Post Article - Timeline layout -->
                <article id="post-@post.PostNumber"
                         class="post-item post-article group @(isOP ? "first-post" : "") @(isModerator ? "moderator-post" : "") timeline @(i == postList.Count - 1 ? "timeline-end-item" : "")"
                         data-author-id="@post.Author.PublicId"
                         data-post-id="@post.PublicId"
                         data-post-number="@post.PostNumber"
                         role="article"
                         aria-label="Post @post.PostNumber by @post.Author.DisplayName">

                    <div class="timeline-start"></div>
                    <div class="timeline-middle">
                        <a href="#post-@post.PostNumber" class="timeline-badge" title="Post #@post.PostNumber">
                            @post.PostNumber
                        </a>
                    </div>
                    <div class="timeline-end w-full">
                        <!-- Two-column layout: Author left, Content right -->
                        <div class="flex gap-6 pb-8">
                            <!-- Left: Author sidebar -->
                            <div class="w-32 flex-shrink-0">
                            @if (!isSameAuthorAsPrevious)
                            {
                                <div class="flex flex-col items-start gap-1">
                                    @if (post.Author.IsDeleted)
                                    {
                                        <div class="w-10 h-10 rounded-full bg-base-200 flex items-center justify-center">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-base-content/50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                            </svg>
                                        </div>
                                        <span class="text-sm italic text-muted">@post.Author.DisplayName</span>
                                    }
                                    else
                                    {
                                        <img src="@(Model.ApiBaseUrl)/avatars/@(post.Author.PublicId)"
                                             alt="@post.Author.DisplayName"
                                             class="w-10 h-10 rounded-full"
                                             loading="lazy" />
                                        <a href="/u/@post.Author.PublicId"
                                           class="text-sm font-medium hover:underline"
                                           data-popup-type="user"
                                           data-popup-id="@post.Author.PublicId"
                                           data-popup-name="@post.Author.DisplayName">@post.Author.DisplayName</a>
                                    }
                                    <div class="flex flex-wrap gap-1">
                                        @if (post.Author.Role == "admin")
                                        {
                                            <span class="badge badge-error-subtle badge-xs">Admin</span>
                                        }
                                        else if (post.Author.Role == "mod")
                                        {
                                            <span class="badge badge-info-subtle badge-xs">Mod</span>
                                        }
                                        @if (isOP)
                                        {
                                            <span class="badge badge-primary-subtle badge-xs">OP</span>
                                        }
                                    </div>
                                </div>
                            }
                            <div class="text-xs text-muted @(!isSameAuthorAsPrevious ? "mt-1" : "")">
                                @Model.FormatRelativeTime(post.CreatedAt)
                                @if (post.EditedAt.HasValue)
                                {
                                    <span>(edited)</span>
                                }
                            </div>
                        </div>

                        <!-- Right: Main content area -->
                        <div class="flex-1 min-w-0">
                            <!-- Reply-to Quote Block -->
                            @if (hasReplyTo)
                            {
                                <a href="#post-@post.ReplyTo!.PostId"
                                   class="editorial-quote block mb-4 text-sm"
                                   onclick="highlightPost('@post.ReplyTo!.PostId')">
                                    <span class="quote-author">@post.ReplyTo!.AuthorName wrote:</span>
                                    <p class="line-clamp-2 mt-1">@post.ReplyTo!.ContentSnippet</p>
                                </a>
                            }

                            <!-- Post Content -->
                            <div id="post-content-@post.PublicId"
                                 class="prose prose-content"
                                 data-raw-content="@Model.EscapeForHtmlAttribute(post.Content)"
                                 data-author-name="@post.Author.DisplayName">
                                @Html.Raw(Model.RenderMarkup(post.Content))
                            </div>

                            <!-- Reactions + Actions row -->
                            <div class="flex items-center gap-4 mt-3">
                                <!-- Reactions (server-rendered) -->
                                <div class="reactions-minimal" id="reactions-@post.PublicId">
                                    @if (post.Reactions?.Counts?.ThumbsUp > 0)
                                    {
                                        var isActive = post.Reactions?.UserReaction == "ThumbsUp" ? "active" : "";
                                        <button type="button" class="reaction-pill @isActive" data-type="ThumbsUp" onclick="event.preventDefault(); event.stopPropagation(); toggleReaction('@post.PublicId', 'ThumbsUp'); return false;">üëç <span class="count">@post.Reactions.Counts.ThumbsUp</span></button>
                                    }
                                    @if (post.Reactions?.Counts?.Heart > 0)
                                    {
                                        var isActive = post.Reactions?.UserReaction == "Heart" ? "active" : "";
                                        <button type="button" class="reaction-pill @isActive" data-type="Heart" onclick="event.preventDefault(); event.stopPropagation(); toggleReaction('@post.PublicId', 'Heart'); return false;">‚ù§Ô∏è <span class="count">@post.Reactions.Counts.Heart</span></button>
                                    }
                                    @if (post.Reactions?.Counts?.Eyes > 0)
                                    {
                                        var isActive = post.Reactions?.UserReaction == "Eyes" ? "active" : "";
                                        <button type="button" class="reaction-pill @isActive" data-type="Eyes" onclick="event.preventDefault(); event.stopPropagation(); toggleReaction('@post.PublicId', 'Eyes'); return false;">üëÄ <span class="count">@post.Reactions.Counts.Eyes</span></button>
                                    }
                                    @if (string.IsNullOrEmpty(post.Reactions?.UserReaction))
                                    {
                                        <button type="button"
                                                class="reaction-pill add-reaction"
                                                onclick="event.preventDefault(); event.stopPropagation(); toggleReactionPicker('@post.PublicId'); return false;"
                                                title="Add reaction"
                                                aria-label="Add reaction to post">
                                            +
                                        </button>
                                    }
                                </div>

                                <!-- Action Buttons -->
                                <div class="subtle-actions flex-1">
                                    @if (!Model.Discussion.IsLocked && Model.IsAuthenticated)
                                    {
                                        <button onclick="replyToPost('@post.PublicId', '@post.Author.DisplayName')"
                                                class="subtle-btn flex items-center gap-1"
                                                aria-label="Reply to @post.Author.DisplayName">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" />
                                            </svg>
                                            Reply
                                        </button>
                                        <button onclick="quotePost('@post.PublicId', '@Model.EscapeForJs(post.Content)', '@post.Author.DisplayName')"
                                                class="subtle-btn flex items-center gap-1"
                                                aria-label="Quote post by @post.Author.DisplayName">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                                            </svg>
                                            Quote
                                        </button>
                                    }

                                    <!-- Right-aligned actions -->
                                    <div class="ml-auto flex items-center gap-1">
                                        <button hx-get="/api/posts/@post.PublicId/history"
                                                hx-target="#history-modal-content"
                                                hx-swap="innerHTML"
                                                onclick="history_modal.showModal()"
                                                class="subtle-btn"
                                                title="History"
                                                aria-label="View post edit history">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                                                <circle cx="12" cy="12" r="11" fill="transparent" pointer-events="all" />
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                            </svg>
                                        </button>
                                        @if (Model.IsAuthenticated && Model.CurrentUserId != post.Author.PublicId)
                                        {
                                            <!-- Non-owner actions dropdown -->
                                            <div class="dropdown dropdown-end">
                                                <button tabindex="0" class="subtle-btn" aria-label="Post options">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h.01M12 12h.01M19 12h.01M6 12a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0z" />
                                                    </svg>
                                                </button>
                                                <ul tabindex="0" class="dropdown-content menu p-1 shadow-lg bg-white border border-subtle rounded-lg w-48 z-20">
                                                    <li>
                                                        <button onclick="hidePostsFromUser('@post.Author.PublicId', '@post.Author.DisplayName')" class="text-sm">
                                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
                                                            </svg>
                                                            Hide posts from user
                                                        </button>
                                                    </li>
                                                    <li>
                                                        <button onclick="openReportModal('post', '@post.PublicId', 'this post')" class="text-sm text-error">
                                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 1H21l-3 6 3 6h-8.5l-1-1H5a2 2 0 00-2 2zm9-13.5V9" />
                                                            </svg>
                                                            Report post
                                                        </button>
                                                    </li>
                                                </ul>
                                            </div>
                                        }
                                        @if (Model.IsAuthenticated && Model.CurrentUserId == post.Author.PublicId)
                                        {
                                            <!-- Owner actions dropdown -->
                                            <div class="dropdown dropdown-end">
                                                <button tabindex="0" class="subtle-btn">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h.01M12 12h.01M19 12h.01M6 12a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0z" />
                                                    </svg>
                                                </button>
                                                <ul tabindex="0" class="dropdown-content menu p-1 shadow-lg bg-white border border-subtle rounded-lg w-36 z-20">
                                                    <li>
                                                        <button onclick="editPost('@post.PublicId', '@Model.CurrentUserId')" class="text-sm">
                                                            Edit
                                                        </button>
                                                    </li>
                                                    <li>
                                                        <button hx-delete="/api/posts/@post.PublicId?userId=@Model.CurrentUserId"
                                                                hx-target="#post-@post.PublicId"
                                                                hx-swap="outerHTML"
                                                                hx-confirm="Are you sure you want to delete this post?"
                                                                class="text-sm text-error">
                                                            Delete
                                                        </button>
                                                    </li>
                                                </ul>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                        </div>
                    </div>

                    @* ==================== OLD LAYOUT - Author on top (commented out) ====================
                    <!-- Author Block -->
                    @if (!isSameAuthorAsPrevious)
                    {
                        <div class="author-block">
                            @if (post.Author.IsDeleted)
                            {
                                <div class="author-avatar-simple">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                    </svg>
                                </div>
                            }
                            else
                            {
                                <div class="author-avatar-simple">
                                    <img src="@(Model.ApiBaseUrl)/avatars/@(post.Author.PublicId)" alt="@post.Author.DisplayName" loading="lazy" />
                                </div>
                            }
                            <div class="author-info">
                                @if (post.Author.IsDeleted)
                                {
                                    <span class="author-name italic text-muted">@post.Author.DisplayName</span>
                                }
                                else
                                {
                                    <a href="/u/@post.Author.PublicId"
                                       class="author-name hover:underline"
                                       data-popup-type="user"
                                       data-popup-id="@post.Author.PublicId"
                                       data-popup-name="@post.Author.DisplayName">@post.Author.DisplayName</a>
                                }
                                @if (post.Author.Role == "admin")
                                {
                                    <span class="badge badge-subtle badge-xs ml-1">Admin</span>
                                }
                                else if (post.Author.Role == "mod")
                                {
                                    <span class="badge badge-subtle badge-xs ml-1">Mod</span>
                                }
                                @if (isOP)
                                {
                                    <span class="badge badge-primary-subtle badge-xs ml-1">OP</span>
                                }
                                <div class="post-meta">
                                    @Model.FormatRelativeTime(post.CreatedAt)
                                    @if (post.EditedAt.HasValue)
                                    {
                                        <span class="ml-1">(edited)</span>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                    else
                    {
                        <!-- Continuation: timestamp only -->
                        <div class="post-meta mb-2">
                            @Model.FormatRelativeTime(post.CreatedAt)
                            @if (post.EditedAt.HasValue)
                            {
                                <span class="ml-1">(edited)</span>
                            }
                        </div>
                    }

                    <!-- Reply-to Quote Block -->
                    @if (hasReplyTo)
                    {
                        <a href="#post-@post.ReplyTo!.PostId"
                           class="editorial-quote block mb-4 text-sm"
                           onclick="highlightPost('@post.ReplyTo!.PostId')">
                            <span class="quote-author">@post.ReplyTo!.AuthorName wrote:</span>
                            <p class="line-clamp-2 mt-1">@post.ReplyTo!.ContentSnippet</p>
                        </a>
                    }

                    <!-- Post Content -->
                    <div id="post-content-@post.PublicId"
                         class="prose prose-content"
                         data-raw-content="@Model.EscapeForHtmlAttribute(post.Content)"
                         data-author-name="@post.Author.DisplayName">
                        @Html.Raw(Model.RenderMarkup(post.Content))
                    </div>

                    <!-- Reactions -->
                    <div class="reactions-minimal" id="reactions-@post.PublicId">
                        <button type="button"
                                class="reaction-pill add-reaction"
                                onclick="event.preventDefault(); event.stopPropagation(); toggleReactionPicker('@post.PublicId'); return false;"
                                title="Add reaction">
                            +
                        </button>
                    </div>
                    ==================== END OLD LAYOUT ==================== *@
                </article>

                previousAuthorId = post.Author.PublicId;
            }

            <!-- Endless scroll or Pagination -->
            @if (Model.PreferEndlessScroll)
            {
                <!-- Endless scroll sentinel -->
                <div id="scroll-sentinel" class="h-4"></div>
                <div id="loading-indicator" class="hidden">
                    <!-- Skeleton loaders -->
                    <div class="skeleton-post">
                        <div class="flex gap-6">
                            <div class="w-32 flex-shrink-0">
                                <div class="skeleton skeleton-avatar"></div>
                            </div>
                            <div class="flex-1">
                                <div class="skeleton skeleton-line" style="width: 30%;"></div>
                                <div class="skeleton skeleton-line"></div>
                                <div class="skeleton skeleton-line"></div>
                                <div class="skeleton skeleton-line short"></div>
                            </div>
                        </div>
                    </div>
                    <div class="skeleton-post">
                        <div class="flex gap-6">
                            <div class="w-32 flex-shrink-0">
                                <div class="skeleton skeleton-avatar"></div>
                            </div>
                            <div class="flex-1">
                                <div class="skeleton skeleton-line" style="width: 25%;"></div>
                                <div class="skeleton skeleton-line"></div>
                                <div class="skeleton skeleton-line short"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="end-message" class="hidden text-center py-8 text-base-content/50 text-sm">
                    You've reached the end
                </div>
                <div id="load-error-message" class="hidden text-center py-8">
                    <div class="inline-flex flex-col items-center gap-3 p-4 bg-error/10 border border-error/20 rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-error" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                        <p class="text-sm text-error font-medium">Failed to load more posts</p>
                        <button onclick="retryLoadPosts()" class="btn btn-sm btn-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                            Retry
                        </button>
                    </div>
                </div>
            }
            else if (Model.Posts.Offset > 0 || Model.Posts.HasMoreItems)
            {
                <nav class="flex justify-center gap-2 pt-6 mt-6 border-t border-subtle">
                    @if (Model.Posts.Offset > 0)
                    {
                        <button class="btn btn-ghost btn-sm"
                                hx-get="@SnakkUrlHelper.DiscussionWithOffset(Model.Community, Model.HubSlug, Model.SpaceSlug, Model.SlugWithId, Math.Max(0, Model.Posts.Offset - Model.Posts.PageSize))"
                                hx-target="#posts-container"
                                hx-swap="innerHTML"
                                hx-push-url="true">
                            Previous
                        </button>
                    }
                    @if (Model.Posts.HasMoreItems)
                    {
                        <button class="btn btn-ghost btn-sm"
                                hx-get="@SnakkUrlHelper.DiscussionWithOffset(Model.Community, Model.HubSlug, Model.SpaceSlug, Model.SlugWithId, Model.Posts.Offset + Model.Posts.PageSize)"
                                hx-target="#posts-container"
                                hx-swap="innerHTML"
                                hx-push-url="true">
                            Next
                        </button>
                    }
                </nav>
            }
        }
        else
        {
            <div class="empty-state-simple">
                <h3>Start the conversation</h3>
                <p>Be the first to share your thoughts on this discussion.</p>
            </div>
        }
    </div>

    <!-- Typing Indicator -->
    <div id="typing-indicator" class="hidden max-w-6xl mx-auto mt-4">
        <div class="typing-indicator-subtle">
            <div class="typing-dots-subtle">
                <div class="typing-dot-subtle"></div>
                <div class="typing-dot-subtle"></div>
                <div class="typing-dot-subtle"></div>
            </div>
            <span id="typing-users">Someone is typing...</span>
        </div>
    </div>

    <!-- Reply Form -->
    @if (Model.Discussion.IsLocked)
    {
        <div class="max-w-6xl mx-auto mt-8">
            <div class="clean-card p-6 text-center">
                <h3 class="font-semibold mb-1">Discussion Locked</h3>
                <p class="text-sm text-muted">This discussion has been locked. No new replies can be added.</p>
            </div>
        </div>
    }
    else if (!Model.IsAuthenticated)
    {
        <div class="max-w-6xl mx-auto mt-8">
            <div class="clean-card p-6 text-center">
                <h3 class="font-semibold mb-1">Join the conversation</h3>
                <p class="text-sm text-muted mb-4">Log in to reply to this discussion.</p>
                <a href="/auth/login?returnUrl=@Uri.EscapeDataString($"/h/{Model.HubSlug}/{Model.SpaceSlug}/{Model.SlugWithId}")" class="btn btn-primary btn-sm">
                    Log in
                </a>
                <span class="mx-2 text-muted">or</span>
                <a href="/auth/register?returnUrl=@Uri.EscapeDataString($"/h/{Model.HubSlug}/{Model.SpaceSlug}/{Model.SlugWithId}")" class="btn btn-ghost btn-sm">
                    Sign up
                </a>
            </div>
        </div>
    }
    else
    {
        <div id="reply-form-container" class="max-w-6xl mx-auto mt-8">
            <!-- Reply context indicator -->
            <div id="reply-context" class="hidden mb-3 p-3 bg-subtle border border-subtle rounded-lg flex items-center justify-between">
                <span class="text-sm text-muted">
                    Replying to <span id="reply-context-author" class="font-semibold"></span>
                </span>
                <button type="button" onclick="clearReplyContext()" class="subtle-btn">
                    Cancel
                </button>
            </div>

            <div class="composer-area">
                <form method="post" id="reply-form">
                    <input type="hidden" name="ReplyToPostId" id="reply-to-post-id" value="" />

                    <textarea name="PostContent"
                              id="post-content-input"
                              placeholder="Share your thoughts..."
                              oninput="autoGrow(this); updatePreviewDebounced(); notifyTyping()"
                              onkeydown="handleEditorKeydown(event)"
                              required></textarea>

                    <!-- Preview Panel (hidden by default) -->
                    <div id="preview-panel" class="hidden border-t border-subtle pt-4 mt-4">
                        <div id="preview-content" class="prose prose-content">
                            <p class="text-muted italic">Nothing to preview</p>
                        </div>
                    </div>

                    <div class="composer-toolbar">
                        <div class="toolbar-buttons">
                            <button type="button" onclick="insertMarkup('**', '**')" class="toolbar-btn font-bold" title="Bold">B</button>
                            <button type="button" onclick="insertMarkup('*', '*')" class="toolbar-btn italic" title="Italic">I</button>
                            <button type="button" onclick="insertMarkup('`', '`')" class="toolbar-btn font-mono text-xs" title="Code">&lt;/&gt;</button>
                            <button type="button" onclick="insertMarkup('[', '](url)')" class="toolbar-btn" title="Link">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                                </svg>
                            </button>
                            <button type="button" onclick="insertLinePrefix('> ')" class="toolbar-btn" title="Quote">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                                </svg>
                            </button>
                            <button type="button" class="toolbar-btn" onclick="document.getElementById('preview-toggle').click()" title="Preview">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                </svg>
                            </button>
                            <input type="checkbox" id="preview-toggle" class="hidden" onchange="togglePreview(this.checked)" />
                        </div>
                        <button type="submit" class="btn btn-primary btn-sm">
                            Post Reply
                        </button>
                    </div>
                </form>
            </div>
        </div>
    }
}
else
{
    <div class="max-w-xl mx-auto empty-state-simple">
        <h3>Discussion not found</h3>
        <p>This discussion may have been removed or the link might be incorrect.</p>
        <a href="/hubs" class="btn btn-primary btn-sm mt-4">Back to Hubs</a>
    </div>
}

<!-- History Modal -->
<dialog id="history_modal" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box max-w-2xl">
        <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold text-lg">Edit History</h3>
            <form method="dialog">
                <button class="subtle-btn">Close</button>
            </form>
        </div>
        <div id="history-modal-content" class="py-2 min-h-32 flex items-center justify-center">
            <span class="loading loading-spinner loading-md text-muted"></span>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<!-- Report Modal -->
<dialog id="report_modal" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box max-w-md">
        <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold text-lg">Report Content</h3>
            <form method="dialog">
                <button class="subtle-btn">Close</button>
            </form>
        </div>
        <p class="text-sm text-muted mb-4">
            You're reporting <span id="report-target-description" class="font-medium"></span>.
            Please select a reason and optionally provide additional details.
        </p>
        <form id="report-form" onsubmit="submitReport(event)">
            <input type="hidden" id="report-type" name="type" value="" />
            <input type="hidden" id="report-target-id" name="targetId" value="" />

            <div class="form-control mb-4">
                <label class="label">
                    <span class="label-text">Reason <span class="text-error">*</span></span>
                </label>
                <select id="report-reason" name="reasonId" class="select select-bordered w-full" required>
                    <option value="">Select a reason...</option>
                </select>
                <div id="report-reason-description" class="text-xs text-muted mt-1 hidden"></div>
            </div>

            <div class="form-control mb-4">
                <label class="label">
                    <span class="label-text">Additional Details (optional)</span>
                </label>
                <textarea id="report-details"
                          name="details"
                          class="textarea textarea-bordered w-full"
                          rows="3"
                          placeholder="Provide any additional context that might help moderators..."></textarea>
            </div>

            <div id="report-error" class="alert alert-error text-sm mb-4 hidden">
                <span id="report-error-message"></span>
            </div>

            <div id="report-success" class="alert alert-success text-sm mb-4 hidden">
                <span>Report submitted successfully. Thank you for helping keep our community safe.</span>
            </div>

            <div class="modal-action">
                <button type="button" onclick="document.getElementById('report_modal').close()" class="btn btn-ghost">Cancel</button>
                <button type="submit" id="report-submit-btn" class="btn btn-error">
                    <span id="report-submit-text">Submit Report</span>
                    <span id="report-submit-loading" class="loading loading-spinner loading-sm hidden"></span>
                </button>
            </div>
        </form>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<!-- Reaction Picker -->
<div id="reaction-picker" class="hidden fixed z-50 bg-white border border-subtle rounded-lg shadow-lg p-2" hx-boost="false">
    <div class="flex gap-1">
        <button type="button" onclick="event.preventDefault(); event.stopPropagation(); toggleReaction(currentReactionPostId, 'ThumbsUp'); return false;" class="reaction-pill" title="Thumbs Up">üëç</button>
        <button type="button" onclick="event.preventDefault(); event.stopPropagation(); toggleReaction(currentReactionPostId, 'Heart'); return false;" class="reaction-pill" title="Heart">‚ù§Ô∏è</button>
        <button type="button" onclick="event.preventDefault(); event.stopPropagation(); toggleReaction(currentReactionPostId, 'Eyes'); return false;" class="reaction-pill" title="Eyes">üëÄ</button>
    </div>
</div>

<!-- Animation styles moved to site.css -->

<!-- Utility Scripts -->
<script src="~/js/cache-manager.js"></script>
<script src="~/js/read-history.js"></script>
<script src="~/js/follow-cache.js"></script>
<script src="~/js/draft-manager.js"></script>
<script src="~/js/read-state-batcher.js"></script>


<script>
// ===== Editor Functions =====

// Auto-grow textarea
function autoGrow(element) {
    element.style.height = 'auto';
    element.style.height = Math.max(96, element.scrollHeight) + 'px'; // min-h-24 = 96px
}

// Insert markup around selection or at cursor
function insertMarkup(before, after) {
    const textarea = document.getElementById('post-content-input');
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const text = textarea.value;
    const selected = text.substring(start, end);

    textarea.value = text.substring(0, start) + before + selected + after + text.substring(end);

    // Position cursor appropriately
    if (selected) {
        textarea.selectionStart = start;
        textarea.selectionEnd = start + before.length + selected.length + after.length;
    } else {
        textarea.selectionStart = textarea.selectionEnd = start + before.length;
    }
    textarea.focus();
    autoGrow(textarea);
    updatePreviewDebounced();
}

// Insert prefix at start of current line
function insertLinePrefix(prefix) {
    const textarea = document.getElementById('post-content-input');
    const start = textarea.selectionStart;
    const text = textarea.value;

    // Find start of current line
    let lineStart = start;
    while (lineStart > 0 && text[lineStart - 1] !== '\n') {
        lineStart--;
    }

    textarea.value = text.substring(0, lineStart) + prefix + text.substring(lineStart);
    textarea.selectionStart = textarea.selectionEnd = start + prefix.length;
    textarea.focus();
    autoGrow(textarea);
    updatePreviewDebounced();
}

// Handle keyboard shortcuts
function handleEditorKeydown(event) {
    // Ctrl+Enter to submit
    if (event.ctrlKey && event.key === 'Enter') {
        event.preventDefault();
        document.getElementById('reply-form').submit();
        return;
    }
    // Ctrl+B for bold
    if (event.ctrlKey && event.key === 'b') {
        event.preventDefault();
        insertMarkup('**', '**');
        return;
    }
    // Ctrl+I for italic
    if (event.ctrlKey && event.key === 'i') {
        event.preventDefault();
        insertMarkup('*', '*');
        return;
    }
    // Ctrl+K for link
    if (event.ctrlKey && event.key === 'k') {
        event.preventDefault();
        insertMarkup('[', '](url)');
        return;
    }
}

// Preview toggle
let previewVisible = false;
function togglePreview(show) {
    previewVisible = show;
    const textarea = document.getElementById('post-content-input');
    const previewPanel = document.getElementById('preview-panel');

    if (show) {
        previewPanel.classList.remove('hidden');
        textarea.style.display = 'none';
        updatePreview();
    } else {
        previewPanel.classList.add('hidden');
        textarea.style.display = '';
        textarea.focus();
    }
}

// Update preview via htmx
let previewTimeout = null;
function updatePreviewDebounced() {
    if (!previewVisible) return;
    clearTimeout(previewTimeout);
    previewTimeout = setTimeout(updatePreview, 300);
}

function updatePreview() {
    if (!previewVisible) return;
    const content = document.getElementById('post-content-input').value;
    const previewContent = document.getElementById('preview-content');

    if (!content.trim()) {
        previewContent.innerHTML = '<p class="text-base-content/50 italic">Nothing to preview</p>';
        return;
    }

    // API base URL
    const apiBaseUrl = window.snakkApiBaseUrl || 'https://localhost:7291';

    fetch(`/bff/markup/preview`, {
        method: 'POST',
        body: content,
        headers: { 'Content-Type': 'text/plain' },
        credentials: 'include'
    })
    .then(response => response.text())
    .then(html => {
        previewContent.innerHTML = html;
    })
    .catch(() => {
        previewContent.innerHTML = '<p class="text-error">Preview failed</p>';
    });
}

// ===== Reply/Quote Functions =====

// Reply to a specific post
function replyToPost(postId, authorName) {
    document.getElementById('reply-to-post-id').value = postId;
    document.getElementById('reply-context').classList.remove('hidden');
    document.getElementById('reply-context-author').textContent = authorName;
    const textarea = document.getElementById('post-content-input');
    textarea.focus();
    autoGrow(textarea);
    document.getElementById('reply-form-container').scrollIntoView({ behavior: 'smooth', block: 'center' });
}

// Quote a post's content (or selected text)
function quotePost(postId, content, authorName) {
    const textarea = document.getElementById('post-content-input');
    const quote = `> ${authorName} wrote:\n> ${content.split('\n').join('\n> ')}\n\n`;
    textarea.value = quote + textarea.value;
    replyToPost(postId, authorName);
    autoGrow(textarea);
    updatePreviewDebounced();
}

// ===== Smart Selection Quote =====

// Track current selection for smart quoting
let currentSelection = { postId: null, text: '', authorName: '' };

function hideSelectionQuoteButton() {
    const btn = document.getElementById('selection-quote-btn');
    if (btn) btn.remove();
}

function showSelectionQuoteButton() {
    hideSelectionQuoteButton(); // Remove any existing

    const selection = window.getSelection();
    if (!selection.rangeCount || !currentSelection.text) return;

    const range = selection.getRangeAt(0);
    const rect = range.getBoundingClientRect();

    // Don't show if rect is invalid (collapsed selection)
    if (rect.width === 0 && rect.height === 0) return;

    const button = document.createElement('button');
    button.id = 'selection-quote-btn';
    button.className = 'fixed z-50 btn btn-xs btn-primary';
    button.textContent = 'Quote selection';

    // Position BELOW the selection (to avoid Edge's mini menu above)
    const left = Math.max(10, rect.left);
    const top = rect.bottom + window.scrollY + 5;

    button.style.left = `${left}px`;
    button.style.top = `${top}px`;

    button.onmousedown = (e) => {
        e.preventDefault(); // Prevent losing selection
    };

    button.onclick = (e) => {
        e.preventDefault();
        e.stopPropagation();
        quotePost(currentSelection.postId, currentSelection.text, currentSelection.authorName);
        hideSelectionQuoteButton();
        window.getSelection().removeAllRanges();
    };

    document.body.appendChild(button);
}

// Check selection on mouseup anywhere in document
document.addEventListener('mouseup', (e) => {
    // Small delay to let selection finalize
    setTimeout(() => {
        const selection = window.getSelection();
        const selectedText = selection.toString().trim();

        if (!selectedText || selectedText.length < 3) {
            currentSelection = { postId: null, text: '', authorName: '' };
            hideSelectionQuoteButton();
            return;
        }

        // Check if selection is within a post content div
        if (!selection.rangeCount) return;

        const range = selection.getRangeAt(0);
        const container = range.commonAncestorContainer;

        // Find the post content div
        const postContentDiv = container.nodeType === Node.TEXT_NODE
            ? container.parentElement?.closest('[id^="post-content-"]')
            : container.closest?.('[id^="post-content-"]');

        if (postContentDiv) {
            const postId = postContentDiv.id.replace('post-content-', '');
            const authorName = postContentDiv.dataset.authorName || 'Unknown';

            currentSelection = { postId, text: selectedText, authorName };
            showSelectionQuoteButton();
        } else {
            currentSelection = { postId: null, text: '', authorName: '' };
            hideSelectionQuoteButton();
        }
    }, 10);
});

// Hide quote button when clicking elsewhere (but not on the button itself)
document.addEventListener('mousedown', (e) => {
    const btn = document.getElementById('selection-quote-btn');
    if (btn && !btn.contains(e.target)) {
        hideSelectionQuoteButton();
    }
});

// Hide on scroll
document.addEventListener('scroll', hideSelectionQuoteButton, { passive: true });

// Clear reply context
function clearReplyContext() {
    document.getElementById('reply-to-post-id').value = '';
    document.getElementById('reply-context').classList.add('hidden');
}

// Highlight a referenced post when clicking quote
function highlightPost(postId) {
    const post = document.getElementById('post-' + postId);
    if (post) {
        post.classList.add('post-highlight');
        setTimeout(() => post.classList.remove('post-highlight'), 2000);
    }
}

// Edit post
function editPost(postId, userId) {
    const contentDiv = document.getElementById('post-content-' + postId);
    const rawContent = contentDiv.dataset.rawContent || '';
    const originalHtml = contentDiv.innerHTML;

    // Store original state for cancel
    contentDiv.dataset.originalHtml = originalHtml;

    contentDiv.innerHTML = `
        <form id="edit-form-${postId}" class="space-y-2">
            <textarea class="textarea textarea-bordered w-full min-h-20 text-sm resize-none"
                      id="edit-textarea-${postId}"
                      oninput="autoGrow(this)">${escapeHtml(rawContent)}</textarea>
            <div class="flex items-center justify-between">
                <span class="text-xs text-base-content/50">Supports **bold**, *italic*, \`code\`, [links](url)</span>
                <div class="flex gap-2">
                    <button type="button" class="btn btn-ghost btn-xs" onclick="cancelEdit('${postId}')">Cancel</button>
                    <button type="button" class="btn btn-primary btn-xs" onclick="submitEdit('${postId}', '${userId}')">Save</button>
                </div>
            </div>
        </form>
    `;

    const textarea = document.getElementById('edit-textarea-' + postId);
    autoGrow(textarea);
    textarea.focus();
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function submitEdit(postId, userId) {
    const textarea = document.getElementById('edit-textarea-' + postId);
    const content = textarea.value;

    fetch(`/api/posts/${postId}/edit?userId=${userId}&content=${encodeURIComponent(content)}`, {
        method: 'POST'
    })
    .then(response => response.text())
    .then(html => {
        document.getElementById('post-' + postId).outerHTML = html;
    })
    .catch(error => {
        alert('Error updating post: ' + error);
    });
}

function cancelEdit(postId) {
    const contentDiv = document.getElementById('post-content-' + postId);
    const originalHtml = contentDiv.dataset.originalHtml;
    if (originalHtml) {
        contentDiv.innerHTML = originalHtml;
        delete contentDiv.dataset.originalHtml;
    }
}

// Jump to unread functionality
let lastReadPostId = null;

function jumpToUnread() {
    if (lastReadPostId) {
        // Find the next post after lastReadPostId
        const posts = document.querySelectorAll('.post-item');
        let foundLast = false;
        for (const post of posts) {
            if (foundLast) {
                post.scrollIntoView({ behavior: 'smooth', block: 'center' });
                post.classList.add('post-highlight');
                setTimeout(() => post.classList.remove('post-highlight'), 2000);
                break;
            }
            if (post.dataset.postId === lastReadPostId) {
                foundLast = true;
            }
        }
    }
}

// Mark posts as read on scroll (debounced)
let markReadTimeout = null;
function markPostsAsRead() {
    clearTimeout(markReadTimeout);
    markReadTimeout = setTimeout(() => {
        const posts = document.querySelectorAll('.post-item');
        let lastVisiblePostId = null;

        for (const post of posts) {
            const rect = post.getBoundingClientRect();
            if (rect.bottom > 0 && rect.top < window.innerHeight) {
                lastVisiblePostId = post.dataset.postId;
            }
        }

        if (lastVisiblePostId && lastVisiblePostId !== lastReadPostId) {
            // Batch update via read state batcher (reduces API calls)
            const discussionId = document.body.dataset.discussionId;
            if (discussionId && window.SnakkReadStateBatcher) {
                window.SnakkReadStateBatcher.updateReadState(discussionId, lastVisiblePostId);
            }
            lastReadPostId = lastVisiblePostId;
        }
    }, 1000);
}

// Endless scroll state
const preferEndlessScroll = @(Model.PreferEndlessScroll ? "true" : "false");
let postsCurrentOffset = @(Model.Posts?.Items?.Count() ?? 0);
let postsHasMoreItems = @(Model.Posts?.HasMoreItems == true ? "true" : "false");
let postsIsLoading = false;
const postsPageSize = 20;

// Track observer for cleanup
let postsScrollObserver = null;

// Initialize page functionality
function initDiscussionPage() {
    // Initialize read state batcher
    const isAuth = @(Model.IsAuthenticated ? "true" : "false");
    if (window.SnakkReadStateBatcher) {
        window.SnakkReadStateBatcher.init(isAuth);
    }

    // Track scroll for read state
    window.addEventListener('scroll', markPostsAsRead, { passive: true });

    // Initial mark as read
    markPostsAsRead();

    // Apply hidden users filter
    applyHiddenUsers();

    // Reactions are now rendered server-side, no need to load via API

    // Load follow status
    const discussionId = document.body.dataset.discussionId;
    if (discussionId) {
        loadFollowStatus(discussionId);
        loadMuteStatus(discussionId);

        // Initialize draft auto-save for reply form
        initDraftAutoSave(discussionId);
    }

    // Initialize endless scroll if enabled
    if (preferEndlessScroll) {
        initPostsEndlessScroll();
    }

    // Initialize keyboard navigation
    initKeyboardNavigation();
}

// Initialize draft auto-save
function initDraftAutoSave(discussionId) {
    const textarea = document.getElementById('post-content-input');
    if (!textarea || !window.SnakkDraftManager) return;

    // Restore draft if exists
    const getReplyToPostId = () => {
        return document.getElementById('reply-to-post-id')?.value || null;
    };

    const restored = window.SnakkDraftManager.restoreDraft(discussionId, textarea, getReplyToPostId());

    // Start auto-save
    window.SnakkDraftManager.startAutoSave(discussionId, textarea, getReplyToPostId);

    // Clear draft on successful post
    const form = document.getElementById('reply-form');
    if (form) {
        form.addEventListener('submit', function(e) {
            // Clear draft after a short delay (to ensure post succeeded)
            setTimeout(() => {
                const replyToPostId = getReplyToPostId();
                window.SnakkDraftManager.clearDraftOnSuccess(discussionId, replyToPostId);
            }, 1000);
        });
    }
}

// Run on initial page load
document.addEventListener('DOMContentLoaded', initDiscussionPage);

// Run after HTMX content swap (for SPA-like navigation)
document.body.addEventListener('htmx:load', function(evt) {
    // Only initialize if this is the discussion page content
    if (document.getElementById('posts-container')) {
        initDiscussionPage();
    }
});

// Set API base URL and data attributes for realtime subscriptions
window.snakkApiBaseUrl = '@Model.ApiBaseUrl';
@if (Model.Discussion != null)
{
    <text>
    document.body.dataset.discussionId = '@Model.Discussion.PublicId';
    document.body.dataset.spaceSlug = '@Model.SpaceSlug';
    document.body.dataset.hubSlug = '@Model.HubSlug';

    // Track this discussion visit in read history
    if (window.SnakkReadHistory) {
        window.SnakkReadHistory.addToHistory({
            discussionPublicId: '@Model.Discussion.PublicId',
            discussionTitle: '@Model.Discussion.Title.Replace("'", "\\'").Replace("\"", "\\\"")'.replace(/\n/g, ' '),
            discussionSlug: '@Model.SlugWithId.Split('~')[0]',
            spacePublicId: '@Model.Space?.PublicId',
            spaceSlug: '@Model.SpaceSlug',
            spaceName: '@(Model.Space?.Name?.Replace("'", "\\'").Replace("\"", "\\\"") ?? Model.SpaceSlug)',
            hubPublicId: '@Model.Hub?.PublicId',
            hubSlug: '@Model.HubSlug',
            hubName: '@(Model.Hub?.Name?.Replace("'", "\\'").Replace("\"", "\\\"") ?? Model.HubSlug)',
            communitySlug: '@Model.Community.CommunitySlug',
            communityName: '@(Model.Community.CommunityName?.Replace("'", "\\'").Replace("\"", "\\\"") ?? Model.Community.CommunitySlug)',
            isDefaultCommunity: @(Model.Community.IsDefaultCommunity ? "true" : "false"),
            lastActivityAt: '@(Model.Discussion.LastActivityAt?.ToString("O") ?? Model.Discussion.CreatedAt.ToString("O"))'
        });
    }
    </text>
}

// ===== Reactions System =====
let currentReactionPostId = null;
const reactionEmojis = { ThumbsUp: 'üëç', Heart: '‚ù§Ô∏è', Eyes: 'üëÄ' };

function toggleReactionPicker(postId) {
    const picker = document.getElementById('reaction-picker');
    const btn = document.querySelector(`#reactions-${postId} .add-reaction`);

    if (currentReactionPostId === postId && !picker.classList.contains('hidden')) {
        picker.classList.add('hidden');
        currentReactionPostId = null;
        return;
    }

    currentReactionPostId = postId;
    if (btn) {
        const rect = btn.getBoundingClientRect();
        picker.style.left = `${rect.left}px`;
        // picker is position:fixed, so use viewport-relative coordinates (no scrollY)
        picker.style.top = `${rect.bottom + 5}px`;
    }
    picker.classList.remove('hidden');
}

async function toggleReaction(postId, reactionType) {
    const picker = document.getElementById('reaction-picker');
    picker.classList.add('hidden');
    currentReactionPostId = null;

    if (!postId) {
        console.error('toggleReaction called with no postId');
        return;
    }

    const reactionsBar = document.getElementById(`reactions-${postId}`);
    const originalHTML = reactionsBar?.innerHTML;

    // Optimistic UI update - toggle the reaction immediately
    const button = reactionsBar?.querySelector(`[data-type="${reactionType}"]`);
    if (button) {
        const isActive = button.classList.contains('active');
        const countSpan = button.querySelector('.count');
        const currentCount = parseInt(countSpan?.textContent || '0');

        if (isActive) {
            // Remove reaction
            button.classList.remove('active');
            const newCount = currentCount - 1;
            if (newCount === 0 && countSpan) {
                button.remove();
            } else if (countSpan) {
                countSpan.textContent = newCount;
            }
        } else {
            // Add reaction
            button.classList.add('active');
            if (countSpan) {
                countSpan.textContent = currentCount + 1;
            }
        }
    }

    const apiBaseUrl = window.snakkApiBaseUrl || 'https://localhost:7291';

    try {
        const response = await fetch(`/bff/posts/${postId}/reactions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ emoji: reactionType }),
            credentials: 'include'
        });

        if (!response.ok) {
            // Revert optimistic update on error
            if (reactionsBar && originalHTML) {
                reactionsBar.innerHTML = originalHTML;
            }
            const errorText = await response.text();
            console.error('Failed to toggle reaction:', response.status, errorText);
            showToast('Failed to update reaction. Please try again.', 'error');
            return;
        }

        // Refresh reactions for this post to ensure accuracy
        await loadReactionsForPost(postId);
    } catch (err) {
        // Revert optimistic update on error
        if (reactionsBar && originalHTML) {
            reactionsBar.innerHTML = originalHTML;
        }
        console.error('Error toggling reaction:', err);
        showToast('Network error. Please check your connection.', 'error');
    }
}

async function loadReactionsForPost(postId) {
    const apiBaseUrl = window.snakkApiBaseUrl || 'https://localhost:7291';
    const reactionsBar = document.getElementById(`reactions-${postId}`);
    if (!reactionsBar) return;

    try {
        // Get counts
        const countsResponse = await fetch(`/bff/posts/${postId}/reactions`);
        const counts = await countsResponse.json();

        // Get user's reaction
        const myResponse = await fetch(`/bff/posts/${postId}/reactions/me`, { credentials: 'include' });
        const myReaction = await myResponse.json();

        // Rebuild reactions bar
        let html = '';

        // Add reactions with counts
        // API returns camelCase keys: thumbsUp, heart, eyes
        const keyMap = { ThumbsUp: 'thumbsUp', Heart: 'heart', Eyes: 'eyes' };
        for (const [type, emoji] of Object.entries(reactionEmojis)) {
            const count = counts[keyMap[type]] || 0;
            if (count > 0) {
                const isActive = myReaction.reaction === type ? 'active' : '';
                html += `<button type="button" class="reaction-pill ${isActive}" data-type="${type}" onclick="event.preventDefault(); event.stopPropagation(); toggleReaction('${postId}', '${type}'); return false;">${emoji} <span class="count">${count}</span></button>`;
            }
        }

        // Add the "+" button only if user hasn't reacted yet
        if (!myReaction.reaction) {
            html += `<button type="button" class="reaction-pill add-reaction" onclick="event.preventDefault(); event.stopPropagation(); toggleReactionPicker('${postId}'); return false;" title="Add reaction">+</button>`;
        }

        reactionsBar.innerHTML = html;
    } catch (err) {
        console.error('Error loading reactions:', err);
    }
}

// Load reactions for all posts on page load
function loadAllReactions() {
    document.querySelectorAll('[id^="reactions-"]').forEach(bar => {
        const postId = bar.id.replace('reactions-', '');
        loadReactionsForPost(postId);
    });
}

// Hide reaction picker when clicking outside
document.addEventListener('click', (e) => {
    const picker = document.getElementById('reaction-picker');
    if (picker && !picker.contains(e.target) && !e.target.closest('.add-reaction')) {
        picker.classList.add('hidden');
        currentReactionPostId = null;
    }
});

// ===== Follow Discussion =====
async function toggleFollowDiscussion(discussionId) {
    const apiBaseUrl = window.snakkApiBaseUrl || 'https://localhost:7291';
    const btn = document.getElementById('follow-btn');
    const text = document.getElementById('follow-text');

    // Optimistic UI update - toggle immediately
    const currentlyFollowing = btn.classList.contains('btn-primary');
    const newFollowingState = !currentlyFollowing;
    updateFollowButton(newFollowingState);

    // Update cache optimistically
    if (window.SnakkFollowCache) {
        window.SnakkFollowCache.setDiscussionFollowed(discussionId, newFollowingState);
    }

    try {
        const response = await fetch(`/bff/discussions/${discussionId}/follow`, {
            method: 'POST',
            credentials: 'include'
        });

        if (!response.ok) {
            // Revert optimistic update on error
            updateFollowButton(currentlyFollowing);
            if (window.SnakkFollowCache) {
                window.SnakkFollowCache.setDiscussionFollowed(discussionId, currentlyFollowing);
            }
            console.error('Failed to toggle follow');
            showToast('Failed to update follow status. Please try again.', 'error');
            return;
        }

        const result = await response.json();
        // Update to actual server state (should match optimistic update)
        updateFollowButton(result.isFollowing);
        if (window.SnakkFollowCache) {
            window.SnakkFollowCache.setDiscussionFollowed(discussionId, result.isFollowing);
        }
    } catch (err) {
        // Revert optimistic update on error
        updateFollowButton(currentlyFollowing);
        if (window.SnakkFollowCache) {
            window.SnakkFollowCache.setDiscussionFollowed(discussionId, currentlyFollowing);
        }
        console.error('Error toggling follow:', err);
        showToast('Network error. Please check your connection.', 'error');
    }
}

function updateFollowButton(isFollowing) {
    const btn = document.getElementById('follow-btn');
    const text = document.getElementById('follow-text');
    const icon = document.getElementById('follow-icon');

    if (isFollowing) {
        btn.classList.add('btn-primary');
        btn.classList.remove('btn-ghost');
        text.textContent = 'Following';
        icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />';
    } else {
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-ghost');
        text.textContent = 'Follow';
        icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />';
    }
}

async function loadFollowStatus(discussionId) {
    // Check cache first
    if (window.SnakkFollowCache) {
        const cached = window.SnakkFollowCache.isDiscussionFollowed(discussionId);
        if (cached !== null) {
            updateFollowButton(cached);
            return; // Use cached value, skip API call
        }
    }

    // Cache miss or not available, fetch from API
    const apiBaseUrl = window.snakkApiBaseUrl || 'https://localhost:7291';
    try {
        const response = await fetch(`/bff/discussions/${discussionId}/follow-status`, { credentials: 'include' });
        const result = await response.json();
        updateFollowButton(result.isFollowing);

        // Update cache
        if (window.SnakkFollowCache) {
            window.SnakkFollowCache.setDiscussionFollowed(discussionId, result.isFollowing);
        }
    } catch (err) {
        // Not logged in or error - leave as default
    }
}

// ===== Mute Discussion =====
function toggleMuteDiscussion(discussionId) {
    const mutedDiscussions = JSON.parse(localStorage.getItem('mutedDiscussions') || '[]');
    const isMuted = mutedDiscussions.includes(discussionId);

    if (isMuted) {
        // Unmute
        const index = mutedDiscussions.indexOf(discussionId);
        mutedDiscussions.splice(index, 1);
        localStorage.setItem('mutedDiscussions', JSON.stringify(mutedDiscussions));
        updateMuteButton(false);
    } else {
        // Mute
        mutedDiscussions.push(discussionId);
        localStorage.setItem('mutedDiscussions', JSON.stringify(mutedDiscussions));
        updateMuteButton(true);

        // Show confirmation
        const banner = document.createElement('div');
        banner.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 bg-base-100 border border-subtle px-4 py-3 rounded-lg shadow-lg z-50';
        banner.innerHTML = `
            <div class="flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-muted" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2" />
                </svg>
                <p class="text-sm">Discussion muted. You won't see it in your feed.</p>
            </div>
        `;
        document.body.appendChild(banner);
        setTimeout(() => banner.remove(), 3000);
    }
}

function updateMuteButton(isMuted) {
    const btn = document.getElementById('mute-discussion-btn');
    const text = document.getElementById('mute-text');

    if (isMuted) {
        text.textContent = 'Unmute discussion';
    } else {
        text.textContent = 'Mute discussion';
    }
}

function loadMuteStatus(discussionId) {
    const mutedDiscussions = JSON.parse(localStorage.getItem('mutedDiscussions') || '[]');
    const isMuted = mutedDiscussions.includes(discussionId);
    updateMuteButton(isMuted);
}

// ===== Hide Posts From User =====
function hidePostsFromUser(userId, userName) {
    const hiddenUsers = JSON.parse(localStorage.getItem('hiddenUsers') || '[]');

    if (!hiddenUsers.includes(userId)) {
        hiddenUsers.push(userId);
        localStorage.setItem('hiddenUsers', JSON.stringify(hiddenUsers));

        // Hide all posts from this user
        document.querySelectorAll(`[data-author-id="${userId}"]`).forEach(post => {
            post.style.display = 'none';
        });

        // Show confirmation
        const banner = document.createElement('div');
        banner.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 bg-base-100 border border-subtle px-4 py-3 rounded-lg shadow-lg z-50';
        banner.innerHTML = `
            <div class="flex items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-muted" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
                </svg>
                <div>
                    <p class="text-sm font-medium">Posts from ${userName} are now hidden</p>
                    <button onclick="unhideUser('${userId}')" class="text-xs text-primary underline">Undo</button>
                </div>
            </div>
        `;
        document.body.appendChild(banner);
        setTimeout(() => banner.remove(), 5000);
    }
}

function unhideUser(userId) {
    const hiddenUsers = JSON.parse(localStorage.getItem('hiddenUsers') || '[]');
    const index = hiddenUsers.indexOf(userId);

    if (index > -1) {
        hiddenUsers.splice(index, 1);
        localStorage.setItem('hiddenUsers', JSON.stringify(hiddenUsers));

        // Show all posts from this user
        document.querySelectorAll(`[data-author-id="${userId}"]`).forEach(post => {
            post.style.display = '';
        });

        // Remove any notification banners
        document.querySelectorAll('.fixed.top-20').forEach(banner => banner.remove());
    }
}

function applyHiddenUsers() {
    const hiddenUsers = JSON.parse(localStorage.getItem('hiddenUsers') || '[]');

    hiddenUsers.forEach(userId => {
        document.querySelectorAll(`[data-author-id="${userId}"]`).forEach(post => {
            post.style.display = 'none';
        });
    });
}

// ===== Typing Indicator =====
let typingTimeout = null;
let isTyping = false;

function notifyTyping() {
    if (!isTyping) {
        isTyping = true;
        // TODO: Send typing start notification via SignalR
        // connection.invoke('StartTyping', discussionId);
    }

    clearTimeout(typingTimeout);
    typingTimeout = setTimeout(() => {
        isTyping = false;
        // TODO: Send typing stop notification via SignalR
        // connection.invoke('StopTyping', discussionId);
    }, 2000);
}

function showTypingIndicator(users) {
    const indicator = document.getElementById('typing-indicator');
    const usersSpan = document.getElementById('typing-users');

    if (users && users.length > 0) {
        if (users.length === 1) {
            usersSpan.textContent = `${users[0]} is typing...`;
        } else if (users.length === 2) {
            usersSpan.textContent = `${users[0]} and ${users[1]} are typing...`;
        } else {
            usersSpan.textContent = `${users.length} people are typing...`;
        }
        indicator.classList.remove('hidden');
    } else {
        indicator.classList.add('hidden');
    }
}

// ===== Keyboard Navigation =====
let currentPostIndex = -1;
const posts = [];

function initKeyboardNavigation() {
    // Build posts array for navigation
    document.querySelectorAll('.post-article').forEach(post => {
        posts.push(post);
    });

    document.addEventListener('keydown', (e) => {
        // Don't intercept if user is typing in an input/textarea
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
            return;
        }

        // Don't intercept if modals/pickers are open
        const picker = document.getElementById('reaction-picker');
        if (picker && !picker.classList.contains('hidden')) {
            if (e.key === 'Escape') {
                picker.classList.add('hidden');
                currentReactionPostId = null;
            }
            return;
        }

        switch(e.key) {
            case 'j': // Next post
            case 'ArrowDown':
                e.preventDefault();
                navigateToPost(currentPostIndex + 1);
                break;
            case 'k': // Previous post
            case 'ArrowUp':
                e.preventDefault();
                navigateToPost(currentPostIndex - 1);
                break;
            case 'r': // Reply to current post or focus composer
                e.preventDefault();
                const composer = document.getElementById('comment-input');
                if (composer) {
                    composer.focus();
                    composer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                break;
            case 'Escape': // Clear selection/close things
                if (currentPostIndex >= 0) {
                    posts[currentPostIndex]?.classList.remove('keyboard-selected');
                    currentPostIndex = -1;
                }
                break;
        }
    });
}

function navigateToPost(index) {
    // Clear previous selection
    if (currentPostIndex >= 0 && posts[currentPostIndex]) {
        posts[currentPostIndex].classList.remove('keyboard-selected');
    }

    // Clamp index
    if (index < 0) index = 0;
    if (index >= posts.length) index = posts.length - 1;

    currentPostIndex = index;

    if (posts[currentPostIndex]) {
        posts[currentPostIndex].classList.add('keyboard-selected');
        posts[currentPostIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
}

// Demo: Show typing indicator briefly on page load (remove in production)
// setTimeout(() => showTypingIndicator(['Someone']), 2000);
// setTimeout(() => showTypingIndicator([]), 5000);

// ===== Toast Notifications =====
function showToast(message, type = 'error', duration = 4000) {
    const toast = document.createElement('div');
    const bgColor = type === 'error' ? 'bg-error' : type === 'success' ? 'bg-success' : 'bg-info';
    toast.className = `fixed bottom-6 right-6 ${bgColor} text-white px-4 py-3 rounded-lg shadow-lg z-50 flex items-center gap-2 max-w-sm`;
    toast.style.transition = 'all 0.3s ease';
    toast.style.transform = 'translateX(400px)';

    const icon = type === 'error'
        ? '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>'
        : type === 'success'
        ? '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>'
        : '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>';

    toast.innerHTML = `
        ${icon}
        <p class="text-sm">${message}</p>
    `;

    document.body.appendChild(toast);

    // Animate in
    setTimeout(() => {
        toast.style.transform = 'translateX(0)';
    }, 10);

    // Remove after duration
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(400px)';
        setTimeout(() => toast.remove(), 300);
    }, duration);
}

// ===== Endless Scroll for Posts =====
function initPostsEndlessScroll() {
    const sentinel = document.getElementById('scroll-sentinel');
    if (!sentinel) return;

    // Disconnect previous observer if it exists
    if (postsScrollObserver) {
        postsScrollObserver.disconnect();
    }

    postsScrollObserver = new IntersectionObserver((entries) => {
        if (entries[0].isIntersecting && postsHasMoreItems && !postsIsLoading) {
            loadMorePosts();
        }
    }, { rootMargin: '100px' });

    postsScrollObserver.observe(sentinel);
}

async function loadMorePosts() {
    if (postsIsLoading || !postsHasMoreItems) return;
    postsIsLoading = true;

    const loadingIndicator = document.getElementById('loading-indicator');
    const endMessage = document.getElementById('end-message');
    loadingIndicator?.classList.remove('hidden');

    const discussionId = '@Model.Discussion?.PublicId';
    const apiBaseUrl = window.snakkApiBaseUrl || 'https://localhost:7291';

    try {
        const response = await fetch(
            `${apiBaseUrl}/api/discussions/${discussionId}/posts?offset=${postsCurrentOffset}&pageSize=${postsPageSize}`,
            { credentials: 'include' }
        );

        if (!response.ok) throw new Error('Failed to load posts');

        const data = await response.json();
        const container = document.getElementById('posts-container');
        const sentinel = document.getElementById('scroll-sentinel');

        if (data.items && data.items.length > 0) {
            // Track previous author for grouping
            const existingPosts = container.querySelectorAll('.post-item');
            let previousAuthorId = existingPosts.length > 0
                ? existingPosts[existingPosts.length - 1].dataset.authorId
                : null;

            const newPostIds = [];
            data.items.forEach(post => {
                const isSameAuthor = previousAuthorId === post.author.publicId;
                const postElement = createPostElement(post, isSameAuthor);
                container.insertBefore(postElement, sentinel);
                previousAuthorId = post.author.publicId;
                newPostIds.push(post.publicId);

                // Load reactions for this new post
                loadReactionsForPost(post.publicId);
            });
            postsCurrentOffset += data.items.length;

            // Render markdown for new posts
            newPostIds.forEach(postId => renderPostContent(postId));
        }

        postsHasMoreItems = data.hasMoreItems;

        if (!postsHasMoreItems) {
            endMessage?.classList.remove('hidden');
            // Disconnect the observer - no more posts to load
            if (postsScrollObserver) {
                postsScrollObserver.disconnect();
                postsScrollObserver = null;
            }
        }
    } catch (err) {
        console.error('Failed to load more posts:', err);
        // Show error message with retry button
        const errorMessage = document.getElementById('load-error-message');
        errorMessage?.classList.remove('hidden');
        // Disconnect observer but don't set hasMoreItems to false (allow retry)
        if (postsScrollObserver) {
            postsScrollObserver.disconnect();
            postsScrollObserver = null;
        }
    } finally {
        loadingIndicator?.classList.add('hidden');
        postsIsLoading = false;
    }
}

function retryLoadPosts() {
    const errorMessage = document.getElementById('load-error-message');
    errorMessage?.classList.add('hidden');
    // Reinitialize endless scroll
    if (preferEndlessScroll) {
        initPostsEndlessScroll();
    }
    // Trigger load immediately
    loadMorePosts();
}

async function renderPostContent(postId) {
    const contentDiv = document.getElementById(`post-content-${postId}`);
    if (!contentDiv) return;

    const rawContent = contentDiv.dataset.rawContent;
    if (!rawContent) return;

    const apiBaseUrl = window.snakkApiBaseUrl || 'https://localhost:7291';

    try {
        const response = await fetch(`/bff/markup/preview`, {
            method: 'POST',
            body: rawContent,
            headers: { 'Content-Type': 'text/plain' },
            credentials: 'include'
        });

        if (response.ok) {
            const html = await response.text();
            contentDiv.innerHTML = html;
        }
    } catch (err) {
        console.error('Failed to render post content:', err);
    }
}

function formatPostRelativeTime(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    const now = new Date();
    const diff = now - date;
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(diff / 3600000);
    const days = Math.floor(diff / 86400000);

    if (minutes < 1) return 'just now';
    if (minutes < 60) return `${minutes}m ago`;
    if (hours < 24) return `${hours}h ago`;
    if (days < 7) return `${days}d ago`;
    if (days < 365) return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}

function createPostElement(post, isSameAuthorAsPrevious) {
    const article = document.createElement('article');
    article.id = `post-${post.publicId}`;
    article.className = `post-item post-article group ${post.isFirstPost ? 'first-post' : ''}`;
    article.dataset.authorId = post.author.publicId;
    article.dataset.postId = post.publicId;

    const isOP = post.isFirstPost;
    const hasReplyTo = post.replyTo != null;
    const isAuthenticated = @(Model.IsAuthenticated ? "true" : "false");
    const isLocked = @(Model.Discussion?.IsLocked == true ? "true" : "false");
    const currentUserId = '@Model.CurrentUserId';
    const apiBaseUrl = window.snakkApiBaseUrl || 'https://localhost:7291';

    let authorBlockHtml = '';
    if (!isSameAuthorAsPrevious) {
        let rolesBadge = '';
        if (post.author.role === 'admin') {
            rolesBadge = '<span class="badge badge-subtle badge-xs ml-1">Admin</span>';
        } else if (post.author.role === 'mod') {
            rolesBadge = '<span class="badge badge-subtle badge-xs ml-1">Mod</span>';
        }
        const opBadge = isOP ? '<span class="badge badge-primary-subtle badge-xs ml-1">OP</span>' : '';
        const editedTag = post.editedAt ? '<span class="ml-1">(edited)</span>' : '';

        if (post.author.isDeleted) {
            authorBlockHtml = `
                <div class="author-block">
                    <div class="author-avatar-simple">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                    </div>
                    <div class="author-info">
                        <span class="author-name italic text-muted">${post.author.displayName}</span>
                        ${rolesBadge}${opBadge}
                        <div class="post-meta">${formatPostRelativeTime(post.createdAt)}${editedTag}</div>
                    </div>
                </div>`;
        } else {
            authorBlockHtml = `
                <div class="author-block">
                    <div class="author-avatar-simple">
                        <img src="${apiBaseUrl}/avatars/${post.author.publicId}" alt="${post.author.displayName}" loading="lazy" />
                    </div>
                    <div class="author-info">
                        <a href="/u/${post.author.publicId}" class="author-name hover:underline" data-popup-type="user" data-popup-id="${post.author.publicId}" data-popup-name="${post.author.displayName}">${post.author.displayName}</a>
                        ${rolesBadge}${opBadge}
                        <div class="post-meta">${formatPostRelativeTime(post.createdAt)}${editedTag}</div>
                    </div>
                </div>`;
        }
    } else {
        const editedTag = post.editedAt ? '<span class="ml-1">(edited)</span>' : '';
        authorBlockHtml = `<div class="post-meta mb-2">${formatPostRelativeTime(post.createdAt)}${editedTag}</div>`;
    }

    let replyToHtml = '';
    if (hasReplyTo) {
        replyToHtml = `
            <a href="#post-${post.replyTo.postId}" class="editorial-quote block mb-4 text-sm" onclick="highlightPost('${post.replyTo.postId}')">
                <span class="quote-author">${post.replyTo.authorName} wrote:</span>
                <p class="line-clamp-2 mt-1">${escapeHtml(post.replyTo.contentSnippet)}</p>
            </a>`;
    }

    // Render actions (simplified - full action rendering requires server-side markup)
    let actionsHtml = '';
    if (!isLocked && isAuthenticated) {
        actionsHtml = `
            <button onclick="replyToPost('${post.publicId}', '${escapeHtml(post.author.displayName)}')" class="subtle-btn">Reply</button>
            <button onclick="quotePost('${post.publicId}', \`${escapeHtml(post.content).replace(/`/g, '\\`')}\`, '${escapeHtml(post.author.displayName)}')" class="subtle-btn">Quote</button>`;
    }

    article.innerHTML = `
        ${authorBlockHtml}
        ${replyToHtml}
        <div id="post-content-${post.publicId}" class="prose prose-content" data-raw-content="${escapeHtml(post.content)}" data-author-name="${post.author.displayName}">
            ${post.renderedContent || escapeHtml(post.content)}
        </div>
        <div class="reactions-minimal" id="reactions-${post.publicId}">
            <button type="button" class="reaction-pill add-reaction" onclick="event.preventDefault(); event.stopPropagation(); toggleReactionPicker('${post.publicId}'); return false;" title="Add reaction">+</button>
        </div>
        <div class="subtle-actions">
            ${actionsHtml}
        </div>
    `;

    return article;
}

// ===== Report System =====
let reportReasons = [];

async function loadReportReasons() {
    const apiBaseUrl = window.snakkApiBaseUrl || 'https://localhost:7291';
    const spaceId = '@Model.Space?.PublicId';

    try {
        let url = `${apiBaseUrl}/api/moderation/reports/reasons`;
        if (spaceId) {
            url += `?spaceId=${spaceId}`;
        }

        const response = await fetch(url, { credentials: 'include' });
        if (!response.ok) throw new Error('Failed to load reasons');

        const data = await response.json();
        reportReasons = data.items || [];

        // Populate the select dropdown
        const select = document.getElementById('report-reason');
        select.innerHTML = '<option value="">Select a reason...</option>';
        reportReasons.forEach(reason => {
            const option = document.createElement('option');
            option.value = reason.publicId;
            option.textContent = reason.name;
            option.dataset.description = reason.description || '';
            select.appendChild(option);
        });
    } catch (err) {
        console.error('Error loading report reasons:', err);
    }
}

function openReportModal(type, targetId, description) {
    // Reset the form
    document.getElementById('report-form').reset();
    document.getElementById('report-error').classList.add('hidden');
    document.getElementById('report-success').classList.add('hidden');
    document.getElementById('report-submit-btn').disabled = false;
    document.getElementById('report-submit-text').classList.remove('hidden');
    document.getElementById('report-submit-loading').classList.add('hidden');
    document.getElementById('report-reason-description').classList.add('hidden');

    // Set the target info
    document.getElementById('report-type').value = type;
    document.getElementById('report-target-id').value = targetId;
    document.getElementById('report-target-description').textContent = description;

    // Load reasons if not already loaded
    if (reportReasons.length === 0) {
        loadReportReasons();
    }

    // Show the modal
    document.getElementById('report_modal').showModal();
}

// Show reason description when selected
document.getElementById('report-reason')?.addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    const description = selectedOption?.dataset?.description;
    const descDiv = document.getElementById('report-reason-description');

    if (description) {
        descDiv.textContent = description;
        descDiv.classList.remove('hidden');
    } else {
        descDiv.classList.add('hidden');
    }
});

async function submitReport(event) {
    event.preventDefault();

    const type = document.getElementById('report-type').value;
    const targetId = document.getElementById('report-target-id').value;
    const reasonId = document.getElementById('report-reason').value;
    const details = document.getElementById('report-details').value;

    if (!reasonId) {
        showReportError('Please select a reason for your report.');
        return;
    }

    // Show loading state
    const submitBtn = document.getElementById('report-submit-btn');
    const submitText = document.getElementById('report-submit-text');
    const submitLoading = document.getElementById('report-submit-loading');

    submitBtn.disabled = true;
    submitText.classList.add('hidden');
    submitLoading.classList.remove('hidden');

    const apiBaseUrl = window.snakkApiBaseUrl || 'https://localhost:7291';

    try {
        const requestBody = {
            reasonId: reasonId,
            details: details || null
        };

        // Set the appropriate ID based on type
        if (type === 'post') {
            requestBody.postId = targetId;
        } else if (type === 'discussion') {
            requestBody.discussionId = targetId;
        } else if (type === 'user') {
            requestBody.userId = targetId;
        }

        const response = await fetch(`/bff/moderation/reports`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestBody),
            credentials: 'include'
        });

        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.message || 'Failed to submit report');
        }

        // Show success
        document.getElementById('report-error').classList.add('hidden');
        document.getElementById('report-success').classList.remove('hidden');
        submitBtn.disabled = true;

        // Close the modal after a delay
        setTimeout(() => {
            document.getElementById('report_modal').close();
        }, 2000);

    } catch (err) {
        console.error('Error submitting report:', err);
        showReportError(err.message || 'An error occurred while submitting your report. Please try again.');

        submitBtn.disabled = false;
        submitText.classList.remove('hidden');
        submitLoading.classList.add('hidden');
    }
}

function showReportError(message) {
    const errorDiv = document.getElementById('report-error');
    const errorMessage = document.getElementById('report-error-message');
    errorMessage.textContent = message;
    errorDiv.classList.remove('hidden');
}
</script>
