@page "/h/{hubSlug}/{spaceSlug}/{slugWithId}"
@using Snakk.Web.Helpers
@using Snakk.Web.Services
@model Snakk.Web.Pages.Discussions.DetailModel

@section Styles {
    <link rel="stylesheet" href="~/css/profile.css" asp-append-version="true" />
}

@{
    ViewData["Title"] = Model.Discussion?.Title ?? "Discussion";
}

@section Meta {
    @if (Model.Discussion != null)
    {
        var scheme = ViewContext.HttpContext.Request.Scheme;
        var host = ViewContext.HttpContext.Request.Host.ToString();
        var path = ViewContext.HttpContext.Request.Path.ToString();

        var firstPost = Model.Posts?.Items?.FirstOrDefault();
        var description = firstPost != null
            ? (firstPost.Content.Length > 160 ? firstPost.Content.Substring(0, 157) + "..." : firstPost.Content)
            : Model.Discussion.Title;
        var url = $"{scheme}://{host}{path}";
        var authorAvatar = firstPost?.Author?.AvatarUrl;
        var baseUrl = $"{scheme}://{host}";

        <meta name="description" content="@description" />

        <!-- Open Graph -->
        <meta property="og:title" content="@Model.Discussion.Title" />
        <meta property="og:description" content="@description" />
        <meta property="og:type" content="article" />
        <meta property="og:url" content="@url" />
        @if (!string.IsNullOrEmpty(authorAvatar))
        {
            <meta property="og:image" content="@($"{baseUrl}{authorAvatar}")" />
        }
        <meta property="article:published_time" content="@Model.Discussion.CreatedAt.ToString("O")" />
        <meta property="article:author" content="@(firstPost?.Author?.DisplayName ?? "Anonymous")" />

        <!-- Twitter Card -->
        <meta name="twitter:card" content="summary" />
        <meta name="twitter:title" content="@Model.Discussion.Title" />
        <meta name="twitter:description" content="@description" />
        @if (!string.IsNullOrEmpty(authorAvatar))
        {
            <meta name="twitter:image" content="@($"{baseUrl}{authorAvatar}")" />
        }

        <!-- JSON-LD Structured Data -->
        <script type="application/ld+json">
        {
            "@@context": "https://schema.org",
            "@@type": "DiscussionForumPosting",
            "headline": "@Model.Discussion.Title",
            "url": "@url",
            "datePublished": "@Model.Discussion.CreatedAt.ToString("O")",
            "author": {
                "@@type": "Person",
                "name": "@(firstPost?.Author?.DisplayName ?? "Anonymous")"
            },
            "interactionStatistic": {
                "@@type": "InteractionCounter",
                "interactionType": "https://schema.org/CommentAction",
                "userInteractionCount": @(Model.Discussion.PostCount)
            },
            "isPartOf": {
                "@@type": "WebPage",
                "name": "@(Model.Space?.Name ?? Model.SpaceSlug)"
            }
        }
        </script>

        <!-- Breadcrumb Schema -->
        <script type="application/ld+json">
        {
            "@@context": "https://schema.org",
            "@@type": "BreadcrumbList",
            "itemListElement": [
                {
                    "@@type": "ListItem",
                    "position": 1,
                    "name": "Home",
                    "item": "@($"{baseUrl}/")"
                },
                {
                    "@@type": "ListItem",
                    "position": 2,
                    "name": "Hubs",
                    "item": "@($"{baseUrl}/hubs")"
                },
                {
                    "@@type": "ListItem",
                    "position": 3,
                    "name": "@(Model.Hub?.Name ?? Model.HubSlug)",
                    "item": "@($"{baseUrl}{SnakkUrlHelper.Hub(Model.Community, Model.HubSlug)}")"
                },
                {
                    "@@type": "ListItem",
                    "position": 4,
                    "name": "@(Model.Space?.Name ?? Model.SpaceSlug)",
                    "item": "@($"{baseUrl}{SnakkUrlHelper.Space(Model.Community, Model.HubSlug, Model.SpaceSlug)}")"
                },
                {
                    "@@type": "ListItem",
                    "position": 5,
                    "name": "@Model.Discussion.Title"
                }
            ]
        }
        </script>
    }
}

@if (Model.Discussion != null)
{
    <!-- Breadcrumb -->
    <div class="max-w-6xl mx-auto">
        <nav class="breadcrumb" aria-label="Breadcrumb">
            <ol class="breadcrumb-list" itemscope itemtype="https://schema.org/BreadcrumbList">
                <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
                    <a href="/" itemprop="item">
                        <span itemprop="name">Home</span>
                    </a>
                    <meta itemprop="position" content="1" />
                </li>
                @if (Model.ShowCommunityInBreadcrumb)
                {
                    <li class="breadcrumb-separator" aria-hidden="true">/</li>
                    <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
                        <a href="/communities" itemprop="item">
                            <span itemprop="name">Communities</span>
                        </a>
                        <meta itemprop="position" content="2" />
                    </li>
                    <li class="breadcrumb-separator" aria-hidden="true">/</li>
                    <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
                        <a href="/c/@Model.Community.CommunitySlug" itemprop="item">
                            <span itemprop="name">@(Model.Community.CommunityName ?? Model.Community.CommunitySlug)</span>
                        </a>
                        <meta itemprop="position" content="3" />
                    </li>
                }
                <li class="breadcrumb-separator" aria-hidden="true">/</li>
                <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
                    <a href="/hubs" itemprop="item">
                        <span itemprop="name">Hubs</span>
                    </a>
                    <meta itemprop="position" content="@(Model.ShowCommunityInBreadcrumb ? 4 : 2)" />
                </li>
                <li class="breadcrumb-separator" aria-hidden="true">/</li>
                <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
                    <a href="@SnakkUrlHelper.Hub(Model.Community, Model.HubSlug)"
                       itemprop="item"
                                             data-popup-type="hub"
                       data-popup-id="@Model.Hub?.PublicId"
                       data-popup-name="@Model.Hub?.Name">
                        <span itemprop="name">@(Model.Hub?.Name ?? Model.HubSlug)</span>
                    </a>
                    <meta itemprop="position" content="@(Model.ShowCommunityInBreadcrumb ? 5 : 3)" />
                </li>
                <li class="breadcrumb-separator" aria-hidden="true">/</li>
                <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
                    <a href="@SnakkUrlHelper.Space(Model.Community, Model.HubSlug, Model.SpaceSlug)"
                       itemprop="item"
                                             data-popup-type="space"
                       data-popup-id="@Model.Space?.PublicId"
                       data-popup-name="@Model.Space?.Name">
                        <span itemprop="name">@(Model.Space?.Name ?? Model.SpaceSlug)</span>
                    </a>
                    <meta itemprop="position" content="@(Model.ShowCommunityInBreadcrumb ? 6 : 4)" />
                </li>
                <li class="breadcrumb-separator" aria-hidden="true">/</li>
                <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
                    <span class="breadcrumb-current truncate max-w-xs"
                          data-popup-type="discussion"
                          data-popup-id="@Model.Discussion.PublicId"
                          data-popup-name="@Model.Discussion.Title"
                          itemprop="name">@Model.Discussion.Title</span>
                    <meta itemprop="position" content="@(Model.ShowCommunityInBreadcrumb ? 7 : 5)" />
                </li>
            </ol>
        </nav>
    </div>

    <!-- Thread Header -->
    <div class="max-w-6xl mx-auto">
        <header class="discussion-header">
            <div class="flex items-start justify-between">
                <div>
                    <h1 class="title">@Model.Discussion.Title</h1>
                    <div class="meta flex items-center gap-2">
                        <time datetime="@Model.Discussion.CreatedAt.ToString("O")">
                            @Model.Discussion.CreatedAt.ToString("MMMM d, yyyy")
                        </time>
                        @if (Model.Discussion.IsPinned)
                        {
                            <span class="badge badge-primary-subtle badge-sm">Pinned</span>
                        }
                        @if (Model.Discussion.IsLocked)
                        {
                            <span class="badge badge-warning-subtle badge-sm">Locked</span>
                        }
                    </div>
                </div>
                @if (Model.IsAuthenticated)
                {
                    <div class="flex items-center gap-2">
                        <button id="follow-btn"
                                onclick="toggleFollowDiscussion('@Model.Discussion.PublicId')"
                                class="btn btn-ghost btn-sm follow-btn"
                                aria-label="Follow this discussion">
                            <svg id="follow-icon" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                            </svg>
                            <span id="follow-text">Follow</span>
                        </button>
                        <!-- Discussion actions dropdown -->
                        <div class="dropdown dropdown-end">
                            <button tabindex="0" class="btn btn-ghost btn-sm btn-square" aria-label="Discussion options">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
                                </svg>
                            </button>
                            <ul tabindex="0" class="dropdown-content menu p-1 shadow-lg bg-white border border-subtle rounded-lg w-48 z-20">
                                <li>
                                    <button id="mute-discussion-btn" onclick="toggleMuteDiscussion('@Model.Discussion.PublicId')" class="text-sm">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2" />
                                        </svg>
                                        <span id="mute-text">Mute discussion</span>
                                    </button>
                                </li>
                                <li>
                                    <button onclick="openReportModal('discussion', '@Model.Discussion.PublicId', '@Model.EscapeForJs(Model.Discussion.Title)')" class="text-sm text-error">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                        </svg>
                                        Report
                                    </button>
                                </li>
                            </ul>
                        </div>
                    </div>
                }
            </div>
        </header>
    </div>

    <!-- Jump to Unread Button -->
    <div id="jump-to-unread" class="hidden fixed bottom-6 right-6 z-30">
        <button onclick="jumpToUnread()" class="btn btn-primary btn-sm">
            Jump to unread
        </button>
    </div>

    <!-- Locked Thread Banner -->
    @if (Model.Discussion.IsLocked)
    {
        <div class="max-w-6xl mx-auto mb-4">
            <div class="bg-warning/10 border-l-4 border-warning px-4 py-3 rounded">
                <div class="flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-warning" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                    </svg>
                    <p class="text-sm font-medium text-warning-content">
                        This discussion has been locked. No new replies can be posted.
                    </p>
                </div>
            </div>
        </div>
    }

    <!-- Posts Container -->
    <div id="posts-container" class="max-w-6xl mx-auto">
        @if (Model.Posts != null && Model.Posts.Items.Any())
        {
            var postList = Model.Posts.Items.ToList();
            string? previousAuthorId = null;

            @for (int i = 0; i < postList.Count; i++)
            {
                var post = postList[i];
                var isFirstInThread = i == 0;
                var isSameAuthorAsPrevious = previousAuthorId == post.Author.PublicId && !isFirstInThread;
                var isOP = post.IsFirstPost;
                var hasReplyTo = post.ReplyTo != null;
                var isModerator = post.Author.Role == "mod" || post.Author.Role == "admin";

                <!-- Post Article - Timeline layout -->
                <article id="post-@post.PostNumber"
                         class="post-item post-article group @(isOP ? "first-post" : "") @(isModerator ? "moderator-post" : "") timeline @(i == postList.Count - 1 ? "timeline-end-item" : "")"
                         data-author-id="@post.Author.PublicId"
                         data-post-id="@post.PublicId"
                         data-post-number="@post.PostNumber"
                         role="article"
                         aria-label="Post @post.PostNumber by @post.Author.DisplayName">

                    <div class="timeline-start"></div>
                    <div class="timeline-middle">
                        <a href="#post-@post.PostNumber" class="timeline-badge" title="Post #@post.PostNumber">
                            @post.PostNumber
                        </a>
                    </div>
                    <div class="timeline-end w-full">
                        <!-- Two-column layout: Author left, Content right -->
                        <div class="flex gap-6 pb-8">
                            <!-- Left: Author sidebar -->
                            <div class="w-32 flex-shrink-0">
                            @if (!isSameAuthorAsPrevious)
                            {
                                <div class="flex flex-col items-start gap-1">
                                    @if (post.Author.IsDeleted)
                                    {
                                        <div class="w-10 h-10 rounded-full bg-base-200 flex items-center justify-center">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-base-content/50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                            </svg>
                                        </div>
                                        <span class="text-sm italic text-muted">@post.Author.DisplayName</span>
                                    }
                                    else
                                    {
                                        <img src="@(Model.ApiBaseUrl)/avatars/@(post.Author.PublicId)"
                                             alt="@post.Author.DisplayName"
                                             class="w-10 h-10 rounded-full"
                                             loading="lazy" />
                                        <a href="/u/@post.Author.PublicId"
                                           class="text-sm font-medium hover:underline"
                                           data-popup-type="user"
                                           data-popup-id="@post.Author.PublicId"
                                           data-popup-name="@post.Author.DisplayName">@post.Author.DisplayName</a>
                                    }
                                    <div class="flex flex-wrap gap-1">
                                        @if (post.Author.Role == "admin")
                                        {
                                            <span class="badge badge-error-subtle badge-xs">Admin</span>
                                        }
                                        else if (post.Author.Role == "mod")
                                        {
                                            <span class="badge badge-info-subtle badge-xs">Mod</span>
                                        }
                                        @if (isOP)
                                        {
                                            <span class="badge badge-primary-subtle badge-xs">OP</span>
                                        }
                                    </div>
                                </div>
                            }
                            <div class="text-xs text-muted @(!isSameAuthorAsPrevious ? "mt-1" : "")">
                                @Model.FormatRelativeTime(post.CreatedAt)
                                @if (post.EditedAt.HasValue)
                                {
                                    <span>(edited)</span>
                                }
                            </div>
                        </div>

                        <!-- Right: Main content area -->
                        <div class="flex-1 min-w-0">
                            <!-- Reply-to Quote Block -->
                            @if (hasReplyTo)
                            {
                                <a href="#post-@post.ReplyTo!.PostId"
                                   class="editorial-quote block mb-4 text-sm"
                                   onclick="highlightPost('@post.ReplyTo!.PostId')">
                                    <span class="quote-author">@post.ReplyTo!.AuthorName wrote:</span>
                                    <p class="line-clamp-2 mt-1">@post.ReplyTo!.ContentSnippet</p>
                                </a>
                            }

                            <!-- Post Content -->
                            <div id="post-content-@post.PublicId"
                                 class="prose prose-content"
                                 data-raw-content="@Model.EscapeForHtmlAttribute(post.Content)"
                                 data-author-name="@post.Author.DisplayName">
                                @Html.Raw(Model.RenderMarkup(post.Content))
                            </div>

                            <!-- Reactions + Actions row -->
                            <div class="flex items-center gap-4 mt-3">
                                <!-- Reactions (server-rendered) -->
                                <div class="reactions-minimal" id="reactions-@post.PublicId">
                                    @if (post.Reactions?.Counts?.ThumbsUp > 0)
                                    {
                                        var isActive = post.Reactions?.UserReaction == "ThumbsUp" ? "active" : "";
                                        <button type="button" class="reaction-pill @isActive" data-type="ThumbsUp" onclick="event.preventDefault(); event.stopPropagation(); toggleReaction('@post.PublicId', 'ThumbsUp'); return false;">üëç <span class="count">@post.Reactions.Counts.ThumbsUp</span></button>
                                    }
                                    @if (post.Reactions?.Counts?.Heart > 0)
                                    {
                                        var isActive = post.Reactions?.UserReaction == "Heart" ? "active" : "";
                                        <button type="button" class="reaction-pill @isActive" data-type="Heart" onclick="event.preventDefault(); event.stopPropagation(); toggleReaction('@post.PublicId', 'Heart'); return false;">‚ù§Ô∏è <span class="count">@post.Reactions.Counts.Heart</span></button>
                                    }
                                    @if (post.Reactions?.Counts?.Eyes > 0)
                                    {
                                        var isActive = post.Reactions?.UserReaction == "Eyes" ? "active" : "";
                                        <button type="button" class="reaction-pill @isActive" data-type="Eyes" onclick="event.preventDefault(); event.stopPropagation(); toggleReaction('@post.PublicId', 'Eyes'); return false;">üëÄ <span class="count">@post.Reactions.Counts.Eyes</span></button>
                                    }
                                    @if (string.IsNullOrEmpty(post.Reactions?.UserReaction))
                                    {
                                        <button type="button"
                                                class="reaction-pill add-reaction"
                                                onclick="event.preventDefault(); event.stopPropagation(); toggleReactionPicker('@post.PublicId'); return false;"
                                                title="Add reaction"
                                                aria-label="Add reaction to post">
                                            +
                                        </button>
                                    }
                                </div>

                                <!-- Action Buttons -->
                                <div class="subtle-actions flex-1">
                                    @if (!Model.Discussion.IsLocked && Model.IsAuthenticated)
                                    {
                                        <button onclick="replyToPost('@post.PublicId', '@post.Author.DisplayName')"
                                                class="subtle-btn flex items-center gap-1"
                                                aria-label="Reply to @post.Author.DisplayName">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" />
                                            </svg>
                                            Reply
                                        </button>
                                        <button onclick="quotePost('@post.PublicId', '@Model.EscapeForJs(post.Content)', '@post.Author.DisplayName')"
                                                class="subtle-btn flex items-center gap-1"
                                                aria-label="Quote post by @post.Author.DisplayName">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                                            </svg>
                                            Quote
                                        </button>
                                    }

                                    <!-- Right-aligned actions -->
                                    <div class="ml-auto flex items-center gap-1">
                                        <button hx-get="/api/posts/@post.PublicId/history"
                                                hx-target="#history-modal-content"
                                                hx-swap="innerHTML"
                                                onclick="history_modal.showModal()"
                                                class="subtle-btn"
                                                title="History"
                                                aria-label="View post edit history">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                                                <circle cx="12" cy="12" r="11" fill="transparent" pointer-events="all" />
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                            </svg>
                                        </button>
                                        @if (Model.IsAuthenticated && Model.CurrentUserId != post.Author.PublicId)
                                        {
                                            <!-- Non-owner actions dropdown -->
                                            <div class="dropdown dropdown-end">
                                                <button tabindex="0" class="subtle-btn" aria-label="Post options">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h.01M12 12h.01M19 12h.01M6 12a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0z" />
                                                    </svg>
                                                </button>
                                                <ul tabindex="0" class="dropdown-content menu p-1 shadow-lg bg-white border border-subtle rounded-lg w-48 z-20">
                                                    <li>
                                                        <button onclick="hidePostsFromUser('@post.Author.PublicId', '@post.Author.DisplayName')" class="text-sm">
                                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
                                                            </svg>
                                                            Hide posts from user
                                                        </button>
                                                    </li>
                                                    <li>
                                                        <button onclick="openReportModal('post', '@post.PublicId', 'this post')" class="text-sm text-error">
                                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 1H21l-3 6 3 6h-8.5l-1-1H5a2 2 0 00-2 2zm9-13.5V9" />
                                                            </svg>
                                                            Report post
                                                        </button>
                                                    </li>
                                                </ul>
                                            </div>
                                        }
                                        @if (Model.IsAuthenticated && Model.CurrentUserId == post.Author.PublicId)
                                        {
                                            <!-- Owner actions dropdown -->
                                            <div class="dropdown dropdown-end">
                                                <button tabindex="0" class="subtle-btn">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h.01M12 12h.01M19 12h.01M6 12a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0z" />
                                                    </svg>
                                                </button>
                                                <ul tabindex="0" class="dropdown-content menu p-1 shadow-lg bg-white border border-subtle rounded-lg w-36 z-20">
                                                    <li>
                                                        <button onclick="editPost('@post.PublicId', '@Model.CurrentUserId')" class="text-sm">
                                                            Edit
                                                        </button>
                                                    </li>
                                                    <li>
                                                        <button hx-delete="/api/posts/@post.PublicId?userId=@Model.CurrentUserId"
                                                                hx-target="#post-@post.PublicId"
                                                                hx-swap="outerHTML"
                                                                hx-confirm="Are you sure you want to delete this post?"
                                                                class="text-sm text-error">
                                                            Delete
                                                        </button>
                                                    </li>
                                                </ul>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                        </div>
                    </div>

                    @* ==================== OLD LAYOUT - Author on top (commented out) ====================
                    <!-- Author Block -->
                    @if (!isSameAuthorAsPrevious)
                    {
                        <div class="author-block">
                            @if (post.Author.IsDeleted)
                            {
                                <div class="author-avatar-simple">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                    </svg>
                                </div>
                            }
                            else
                            {
                                <div class="author-avatar-simple">
                                    <img src="@(Model.ApiBaseUrl)/avatars/@(post.Author.PublicId)" alt="@post.Author.DisplayName" loading="lazy" />
                                </div>
                            }
                            <div class="author-info">
                                @if (post.Author.IsDeleted)
                                {
                                    <span class="author-name italic text-muted">@post.Author.DisplayName</span>
                                }
                                else
                                {
                                    <a href="/u/@post.Author.PublicId"
                                       class="author-name hover:underline"
                                       data-popup-type="user"
                                       data-popup-id="@post.Author.PublicId"
                                       data-popup-name="@post.Author.DisplayName">@post.Author.DisplayName</a>
                                }
                                @if (post.Author.Role == "admin")
                                {
                                    <span class="badge badge-subtle badge-xs ml-1">Admin</span>
                                }
                                else if (post.Author.Role == "mod")
                                {
                                    <span class="badge badge-subtle badge-xs ml-1">Mod</span>
                                }
                                @if (isOP)
                                {
                                    <span class="badge badge-primary-subtle badge-xs ml-1">OP</span>
                                }
                                <div class="post-meta">
                                    @Model.FormatRelativeTime(post.CreatedAt)
                                    @if (post.EditedAt.HasValue)
                                    {
                                        <span class="ml-1">(edited)</span>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                    else
                    {
                        <!-- Continuation: timestamp only -->
                        <div class="post-meta mb-2">
                            @Model.FormatRelativeTime(post.CreatedAt)
                            @if (post.EditedAt.HasValue)
                            {
                                <span class="ml-1">(edited)</span>
                            }
                        </div>
                    }

                    <!-- Reply-to Quote Block -->
                    @if (hasReplyTo)
                    {
                        <a href="#post-@post.ReplyTo!.PostId"
                           class="editorial-quote block mb-4 text-sm"
                           onclick="highlightPost('@post.ReplyTo!.PostId')">
                            <span class="quote-author">@post.ReplyTo!.AuthorName wrote:</span>
                            <p class="line-clamp-2 mt-1">@post.ReplyTo!.ContentSnippet</p>
                        </a>
                    }

                    <!-- Post Content -->
                    <div id="post-content-@post.PublicId"
                         class="prose prose-content"
                         data-raw-content="@Model.EscapeForHtmlAttribute(post.Content)"
                         data-author-name="@post.Author.DisplayName">
                        @Html.Raw(Model.RenderMarkup(post.Content))
                    </div>

                    <!-- Reactions -->
                    <div class="reactions-minimal" id="reactions-@post.PublicId">
                        <button type="button"
                                class="reaction-pill add-reaction"
                                onclick="event.preventDefault(); event.stopPropagation(); toggleReactionPicker('@post.PublicId'); return false;"
                                title="Add reaction">
                            +
                        </button>
                    </div>
                    ==================== END OLD LAYOUT ==================== *@
                </article>

                previousAuthorId = post.Author.PublicId;
            }

            <!-- Endless scroll or Pagination -->
            @if (Model.PreferEndlessScroll)
            {
                <!-- Endless scroll sentinel -->
                <div id="scroll-sentinel" class="h-4"></div>
                <div id="loading-indicator" class="hidden">
                    <!-- Skeleton loaders -->
                    <div class="skeleton-post">
                        <div class="flex gap-6">
                            <div class="w-32 flex-shrink-0">
                                <div class="skeleton skeleton-avatar"></div>
                            </div>
                            <div class="flex-1">
                                <div class="skeleton skeleton-line skeleton-width-30"></div>
                                <div class="skeleton skeleton-line"></div>
                                <div class="skeleton skeleton-line"></div>
                                <div class="skeleton skeleton-line short"></div>
                            </div>
                        </div>
                    </div>
                    <div class="skeleton-post">
                        <div class="flex gap-6">
                            <div class="w-32 flex-shrink-0">
                                <div class="skeleton skeleton-avatar"></div>
                            </div>
                            <div class="flex-1">
                                <div class="skeleton skeleton-line skeleton-width-25"></div>
                                <div class="skeleton skeleton-line"></div>
                                <div class="skeleton skeleton-line short"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="end-message" class="hidden text-center py-8 text-base-content/50 text-sm">
                    You've reached the end
                </div>
                <div id="load-error-message" class="hidden text-center py-8">
                    <div class="inline-flex flex-col items-center gap-3 p-4 bg-error/10 border border-error/20 rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-error" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                        <p class="text-sm text-error font-medium">Failed to load more posts</p>
                        <button onclick="retryLoadPosts()" class="btn btn-sm btn-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                            Retry
                        </button>
                    </div>
                </div>
            }
            else if (Model.Posts.Offset > 0 || Model.Posts.HasMoreItems)
            {
                <nav class="flex justify-center gap-2 pt-6 mt-6 border-t border-subtle">
                    @if (Model.Posts.Offset > 0)
                    {
                        <button class="btn btn-ghost btn-sm"
                                hx-get="@SnakkUrlHelper.DiscussionWithOffset(Model.Community, Model.HubSlug, Model.SpaceSlug, Model.SlugWithId, Math.Max(0, Model.Posts.Offset - Model.Posts.PageSize))"
                                hx-target="#posts-container"
                                hx-swap="innerHTML"
                                hx-push-url="true">
                            Previous
                        </button>
                    }
                    @if (Model.Posts.HasMoreItems)
                    {
                        <button class="btn btn-ghost btn-sm"
                                hx-get="@SnakkUrlHelper.DiscussionWithOffset(Model.Community, Model.HubSlug, Model.SpaceSlug, Model.SlugWithId, Model.Posts.Offset + Model.Posts.PageSize)"
                                hx-target="#posts-container"
                                hx-swap="innerHTML"
                                hx-push-url="true">
                            Next
                        </button>
                    }
                </nav>
            }
        }
        else
        {
            <div class="empty-state-simple">
                <h3>Start the conversation</h3>
                <p>Be the first to share your thoughts on this discussion.</p>
            </div>
        }
    </div>

    <!-- Typing Indicator -->
    <div id="typing-indicator" class="hidden max-w-6xl mx-auto mt-4">
        <div class="typing-indicator-subtle">
            <div class="typing-dots-subtle">
                <div class="typing-dot-subtle"></div>
                <div class="typing-dot-subtle"></div>
                <div class="typing-dot-subtle"></div>
            </div>
            <span id="typing-users">Someone is typing...</span>
        </div>
    </div>

    <!-- Reply Form -->
    @if (Model.Discussion.IsLocked)
    {
        <div class="max-w-6xl mx-auto mt-8">
            <div class="clean-card p-6 text-center">
                <h3 class="font-semibold mb-1">Discussion Locked</h3>
                <p class="text-sm text-muted">This discussion has been locked. No new replies can be added.</p>
            </div>
        </div>
    }
    else if (!Model.IsAuthenticated)
    {
        <div class="max-w-6xl mx-auto mt-8">
            <div class="clean-card p-6 text-center">
                <h3 class="font-semibold mb-1">Join the conversation</h3>
                <p class="text-sm text-muted mb-4">Log in to reply to this discussion.</p>
                <a href="/auth/login?returnUrl=@Uri.EscapeDataString($"/h/{Model.HubSlug}/{Model.SpaceSlug}/{Model.SlugWithId}")" class="btn btn-primary btn-sm">
                    Log in
                </a>
                <span class="mx-2 text-muted">or</span>
                <a href="/auth/register?returnUrl=@Uri.EscapeDataString($"/h/{Model.HubSlug}/{Model.SpaceSlug}/{Model.SlugWithId}")" class="btn btn-ghost btn-sm">
                    Sign up
                </a>
            </div>
        </div>
    }
    else
    {
        <div id="reply-form-container" class="max-w-6xl mx-auto mt-8">
            <!-- Reply context indicator -->
            <div id="reply-context" class="hidden mb-3 p-3 bg-subtle border border-subtle rounded-lg flex items-center justify-between">
                <span class="text-sm text-muted">
                    Replying to <span id="reply-context-author" class="font-semibold"></span>
                </span>
                <button type="button" onclick="clearReplyContext()" class="subtle-btn">
                    Cancel
                </button>
            </div>

            <div class="composer-area">
                <form method="post" id="reply-form">
                    <input type="hidden" name="ReplyToPostId" id="reply-to-post-id" value="" />

                    <textarea name="PostContent"
                              id="post-content-input"
                              placeholder="Share your thoughts..."
                              oninput="autoGrow(this); updatePreviewDebounced(); notifyTyping()"
                              onkeydown="handleEditorKeydown(event)"
                              required></textarea>

                    <!-- Preview Panel (hidden by default) -->
                    <div id="preview-panel" class="hidden border-t border-subtle pt-4 mt-4">
                        <div id="preview-content" class="prose prose-content">
                            <p class="text-muted italic">Nothing to preview</p>
                        </div>
                    </div>

                    <div class="composer-toolbar">
                        <div class="toolbar-buttons">
                            <button type="button" onclick="insertMarkup('**', '**')" class="toolbar-btn font-bold" title="Bold">B</button>
                            <button type="button" onclick="insertMarkup('*', '*')" class="toolbar-btn italic" title="Italic">I</button>
                            <button type="button" onclick="insertMarkup('`', '`')" class="toolbar-btn font-mono text-xs" title="Code">&lt;/&gt;</button>
                            <button type="button" onclick="insertMarkup('[', '](url)')" class="toolbar-btn" title="Link">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                                </svg>
                            </button>
                            <button type="button" onclick="insertLinePrefix('> ')" class="toolbar-btn" title="Quote">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                                </svg>
                            </button>
                            <button type="button" class="toolbar-btn" onclick="document.getElementById('preview-toggle').click()" title="Preview">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                </svg>
                            </button>
                            <input type="checkbox" id="preview-toggle" class="hidden" onchange="togglePreview(this.checked)" />
                        </div>
                        <button type="submit" class="btn btn-primary btn-sm">
                            Post Reply
                        </button>
                    </div>
                </form>
            </div>
        </div>
    }
}
else
{
    <div class="max-w-xl mx-auto empty-state-simple">
        <h3>Discussion not found</h3>
        <p>This discussion may have been removed or the link might be incorrect.</p>
        <a href="/hubs" class="btn btn-primary btn-sm mt-4">Back to Hubs</a>
    </div>
}

<!-- History Modal -->
<dialog id="history_modal" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box max-w-2xl">
        <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold text-lg">Edit History</h3>
            <form method="dialog">
                <button class="subtle-btn">Close</button>
            </form>
        </div>
        <div id="history-modal-content" class="py-2 min-h-32 flex items-center justify-center">
            <span class="loading loading-spinner loading-md text-muted"></span>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<!-- Report Modal -->
<dialog id="report_modal" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box max-w-md">
        <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold text-lg">Report Content</h3>
            <form method="dialog">
                <button class="subtle-btn">Close</button>
            </form>
        </div>
        <p class="text-sm text-muted mb-4">
            You're reporting <span id="report-target-description" class="font-medium"></span>.
            Please select a reason and optionally provide additional details.
        </p>
        <form id="report-form" onsubmit="submitReport(event)">
            <input type="hidden" id="report-type" name="type" value="" />
            <input type="hidden" id="report-target-id" name="targetId" value="" />

            <div class="form-control mb-4">
                <label class="label">
                    <span class="label-text">Reason <span class="text-error">*</span></span>
                </label>
                <select id="report-reason" name="reasonId" class="select select-bordered w-full" required>
                    <option value="">Select a reason...</option>
                </select>
                <div id="report-reason-description" class="text-xs text-muted mt-1 hidden"></div>
            </div>

            <div class="form-control mb-4">
                <label class="label">
                    <span class="label-text">Additional Details (optional)</span>
                </label>
                <textarea id="report-details"
                          name="details"
                          class="textarea textarea-bordered w-full"
                          rows="3"
                          placeholder="Provide any additional context that might help moderators..."></textarea>
            </div>

            <div id="report-error" class="alert alert-error text-sm mb-4 hidden">
                <span id="report-error-message"></span>
            </div>

            <div id="report-success" class="alert alert-success text-sm mb-4 hidden">
                <span>Report submitted successfully. Thank you for helping keep our community safe.</span>
            </div>

            <div class="modal-action">
                <button type="button" onclick="document.getElementById('report_modal').close()" class="btn btn-ghost">Cancel</button>
                <button type="submit" id="report-submit-btn" class="btn btn-error">
                    <span id="report-submit-text">Submit Report</span>
                    <span id="report-submit-loading" class="loading loading-spinner loading-sm hidden"></span>
                </button>
            </div>
        </form>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<!-- Reaction Picker -->
<div id="reaction-picker" class="hidden fixed z-50 bg-white border border-subtle rounded-lg shadow-lg p-2">
    <div class="flex gap-1">
        <button type="button" onclick="event.preventDefault(); event.stopPropagation(); toggleReaction(currentReactionPostId, 'ThumbsUp'); return false;" class="reaction-pill" title="Thumbs Up">üëç</button>
        <button type="button" onclick="event.preventDefault(); event.stopPropagation(); toggleReaction(currentReactionPostId, 'Heart'); return false;" class="reaction-pill" title="Heart">‚ù§Ô∏è</button>
        <button type="button" onclick="event.preventDefault(); event.stopPropagation(); toggleReaction(currentReactionPostId, 'Eyes'); return false;" class="reaction-pill" title="Eyes">üëÄ</button>
    </div>
</div>

<!-- Animation styles moved to site.css -->

<!-- Utility Scripts -->
<script src="~/js/cache-manager.js"></script>
<script src="~/js/read-history.js"></script>
<script src="~/js/follow-cache.js"></script>
<script src="~/js/draft-manager.js"></script>
<script src="~/js/read-state-batcher.js"></script>


<script src="~/js/discussion-detail.js" asp-append-version="true"></script>
<script>
@* INLINE REASON: Initialization code with extensive Razor syntax (@Model.Discussion.X, @if blocks).
   Passes server-side discussion metadata to external discussion-detail.js.
   Contains conditional Razor blocks (@if Model.Discussion != null) that can't be in external files.
   Also handles read history tracking with server-generated URLs and titles. *@

// Initialize discussion page with server-side data

// Set API base URL and data attributes for realtime subscriptions
window.snakkApiBaseUrl = '@Model.ApiBaseUrl';

// Track if page has been initialized to prevent duplicate calls
let isDiscussionPageInitialized = false;

// Initialize on DOM ready
document.addEventListener('DOMContentLoaded', function() {
    if (!isDiscussionPageInitialized) {
        isDiscussionPageInitialized = true;
        
        @if (Model.Discussion != null)
        {
            <text>
            document.body.dataset.discussionId = '@Model.Discussion.PublicId';
            document.body.dataset.spaceSlug = '@Model.SpaceSlug';
            document.body.dataset.hubSlug = '@Model.HubSlug';

            // Track this discussion visit in read history
            if (window.SnakkReadHistory) {
                window.SnakkReadHistory.addToHistory({
                    discussionPublicId: '@Model.Discussion.PublicId',
                    discussionTitle: '@Model.Discussion.Title.Replace("'", "\'").Replace("\"", "\\\"")'.replace(/\n/g, ' '),
                    discussionSlug: '@Model.SlugWithId.Split('~')[0]',
                    spacePublicId: '@Model.Space?.PublicId',
                    spaceSlug: '@Model.SpaceSlug',
                    spaceName: '@(Model.Space?.Name?.Replace("'", "\'").Replace("\"", "\\\"") ?? Model.SpaceSlug)',
                    hubPublicId: '@Model.Hub?.PublicId',
                    hubSlug: '@Model.HubSlug',
                    hubName: '@(Model.Hub?.Name?.Replace("'", "\'").Replace("\"", "\\\"") ?? Model.HubSlug)',
                    communitySlug: '@Model.Community.CommunitySlug',
                    communityName: '@(Model.Community.CommunityName?.Replace("'", "\'").Replace("\"", "\\\"") ?? Model.Community.CommunitySlug)',
                    isDefaultCommunity: @(Model.Community.IsDefaultCommunity ? "true" : "false"),
                    lastActivityAt: '@(Model.Discussion.LastActivityAt?.ToString("O") ?? Model.Discussion.CreatedAt.ToString("O"))'
                });
            }
            </text>
        }
        
        // Initialize discussion page
        initDiscussionPage({
            discussionId: '@Model.Discussion?.PublicId',
            isAuthenticated: @(Model.IsAuthenticated ? "true" : "false"),
            currentUserId: '@Model.CurrentUserId',
            isLocked: @(Model.Discussion?.IsLocked == true ? "true" : "false"),
            spaceId: '@Model.Space?.PublicId',
            preferEndlessScroll: @(Model.PreferEndlessScroll ? "true" : "false"),
            postsCurrentOffset: @(Model.Posts?.Items?.Count() ?? 0),
            postsHasMoreItems: @(Model.Posts?.HasMoreItems == true ? "true" : "false")
        });
    }
});

// Run after HTMX content swap (for SPA-like navigation)
document.body.addEventListener('htmx:load', function(evt) {
    // Only initialize if this is the discussion page content AND not already initialized
    if (document.getElementById('posts-container') && !isDiscussionPageInitialized) {
        isDiscussionPageInitialized = true;
        
        @if (Model.Discussion != null)
        {
            <text>
            document.body.dataset.discussionId = '@Model.Discussion.PublicId';
            document.body.dataset.spaceSlug = '@Model.SpaceSlug';
            document.body.dataset.hubSlug = '@Model.HubSlug';
            </text>
        }
        
        // Initialize discussion page
        initDiscussionPage({
            discussionId: '@Model.Discussion?.PublicId',
            isAuthenticated: @(Model.IsAuthenticated ? "true" : "false"),
            currentUserId: '@Model.CurrentUserId',
            isLocked: @(Model.Discussion?.IsLocked == true ? "true" : "false"),
            spaceId: '@Model.Space?.PublicId',
            preferEndlessScroll: @(Model.PreferEndlessScroll ? "true" : "false"),
            postsCurrentOffset: @(Model.Posts?.Items?.Count() ?? 0),
            postsHasMoreItems: @(Model.Posts?.HasMoreItems == true ? "true" : "false")
        });
    }
});
</script>
