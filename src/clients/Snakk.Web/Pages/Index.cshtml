@page
@using Snakk.Web.Helpers
@using Snakk.Web.Services
@model IndexModel
@{
    ViewData["Title"] = "Home";
}

<div class="max-w-6xl mx-auto">
    <!-- Page Header (full width) -->
    <div class="page-header">
        <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-4">
            <div>
                <h1>Latest Discussions</h1>
                <p>Recent activity across all spaces</p>
            </div>
            @if (Model.PlatformStats != null || Model.CommunityStats != null)
            {
                <div class="w-full lg:w-80 flex-shrink-0">
                    <div class="stats-panel">
                        <div class="stats-grid">
                            <div class="stat-item">
                                <span class="stat-value">@Model.SpaceCount</span>
                                <svg class="stat-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="18" cy="5" r="3"></circle>
                                    <circle cx="6" cy="12" r="3"></circle>
                                    <circle cx="18" cy="19" r="3"></circle>
                                    <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                                    <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                                </svg>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value">@Model.DiscussionCount</span>
                                <svg class="stat-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M14 9a2 2 0 0 1-2 2H6l-3 3V4a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2z"></path>
                                    <path d="M21 14a2 2 0 0 1-2 2h-4l-3 3v-3H9a2 2 0 0 1-2-2v-1"></path>
                                </svg>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value">@Model.ReplyCount</span>
                                <svg class="stat-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>

    <div class="flex flex-col lg:flex-row gap-6">
        <!-- Main Content -->
        <div class="flex-1 min-w-0">
            @if (Model.RecentDiscussions?.Items == null || !Model.RecentDiscussions.Items.Any())
            {
                <div class="clean-card">
                    <div class="empty-state-simple">
                        <h3>No discussions yet</h3>
                        <p>Be the first to start a conversation!</p>
                        <a href="/hubs" class="btn btn-primary btn-sm mt-4">Browse Hubs</a>
                    </div>
                </div>
            }
            else
            {
                <div class="topic-list" id="discussions-container">
                    @foreach (var discussion in Model.RecentDiscussions.Items)
                    {
                        var baseUrl = SnakkUrlHelper.Discussion(
                            Model.Community,
                            discussion.Hub.Slug,
                            discussion.Space.Slug,
                            $"{discussion.Slug}~{discussion.PublicId}");

                        var unreadUrl = $"{baseUrl}?gotoUnread=true";

                        <div class="topic-item-wrapper">
                            <img src="@SnakkUrlHelper.UserAvatar(Model.ApiBaseUrl, discussion.Author.PublicId)"
                                 alt="@discussion.Author.DisplayName"
                                 loading="lazy"
                                 class="w-10 h-10 rounded-full flex-shrink-0 mr-2 hidden sm:block" />

                            <div class="topic-item">
                                <div class="topic-content">
                                    <div class="topic-title">
                                        <a href="@baseUrl" class="topic-title-link">@discussion.Title</a>
                                        @if (discussion.IsPinned)
                                        {
                                            <span class="badge badge-primary-subtle badge-xs ml-2">Pinned</span>
                                        }
                                        @if (discussion.IsLocked)
                                        {
                                            <span class="badge badge-warning-subtle badge-xs ml-2">Locked</span>
                                        }
                                        @if (discussion.Tags != null && discussion.Tags.Length > 0)
                                        {
                                            @foreach (var tag in discussion.Tags.Take(3))
                                            {
                                                <span class="badge badge-ghost badge-xs ml-2">@tag</span>
                                            }
                                            @if (discussion.Tags.Length > 3)
                                            {
                                                <span class="text-muted ml-1">...</span>
                                            }
                                        }
                                    </div>
                                    <div class="topic-meta">
                                        @if (Model.ShowCommunityInDiscussionList)
                                        {
                                            <a href="@SnakkUrlHelper.Community(discussion.Community.Slug)"
                                               class="topic-meta-link"
                                               data-popup-type="community"
                                               data-popup-id="@discussion.Community.PublicId"
                                               data-popup-name="@discussion.Community.Name">@discussion.Community.Name</a>
                                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <polyline points="9 18 15 12 9 6"></polyline>
                                            </svg>
                                        }
                                        <a href="@SnakkUrlHelper.Hub(Model.Community, discussion.Hub.Slug)"
                                           class="topic-meta-link"
                                           data-popup-type="hub"
                                           data-popup-id="@discussion.Hub.PublicId"
                                           data-popup-name="@discussion.Hub.Name">@discussion.Hub.Name</a>
                                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <polyline points="9 18 15 12 9 6"></polyline>
                                            </svg>
                                        <a href="@SnakkUrlHelper.Space(Model.Community, discussion.Hub.Slug, discussion.Space.Slug)"
                                           class="topic-meta-link"
                                           data-popup-type="space"
                                           data-popup-id="@discussion.Space.PublicId"
                                           data-popup-name="@discussion.Space.Name">@discussion.Space.Name</a>
                                        <span class="topic-meta-separator">Â·</span>
                                        <span>@Model.GetRelativeTime(discussion.LastActivityAt ?? discussion.CreatedAt)</span>
                                    </div>
                                </div>
                                <div class="topic-stats hidden sm:flex">
                                      <div class="topic-stat">
                                        <div class="topic-stat-icon">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                                            </svg>
                                        </div>
                                        <div class="topic-stat-value">@discussion.ReactionCount</div>
                                    </div>
                                    <div class="topic-stat">
                                        <div class="topic-stat-icon">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                                            </svg>
                                        </div>
                                        <div class="topic-stat-value">@discussion.PostCount</div>
                                    </div>
                                </div>
                            </div>
                            <button class="preview-btn"
                                    data-discussion-id="@discussion.PublicId"
                                    title="Preview first post"
                                    type="button">
                                @* Eye icon - commented out
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                    <circle cx="12" cy="12" r="3"></circle>
                                </svg>
                                *@
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </button>
                            <a href="@unreadUrl" class="topic-latest-link" title="Jump to first unread post">
                                <svg class="chevron-right" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </a>
                        </div>
                        <div class="discussion-preview hidden" data-discussion-id="@discussion.PublicId">
                            <div class="preview-content"></div>
                        </div>
                    }
                </div>

                @if (Model.PreferEndlessScroll)
                {
                    @if (Model.RecentDiscussions.HasMoreItems)
                    {
                        <div id="endless-scroll-sentinel" class="h-4"></div>
                        <div id="loading-indicator" class="flex justify-center py-6 hidden">
                            <span class="loading loading-spinner loading-md"></span>
                        </div>
                        <div id="end-of-list" class="text-center text-muted py-6 hidden">
                            No more discussions
                        </div>
                    }
                    else
                    {
                        <div class="text-center text-muted py-6">
                            You've reached the end
                        </div>
                    }
                }
                else
                {
                    @if (Model.RecentDiscussions.Offset > 0 || Model.RecentDiscussions.HasMoreItems)
                    {
                        <div class="flex justify-center gap-2 mt-6">
                            @if (Model.RecentDiscussions.Offset > 0)
                            {
                                <a href="/?offset=@(Math.Max(0, Model.RecentDiscussions.Offset - Model.RecentDiscussions.PageSize))"
                                   class="btn btn-ghost btn-sm">
                                    Previous
                                </a>
                            }
                            @if (Model.RecentDiscussions.HasMoreItems)
                            {
                                <a href="/?offset=@(Model.RecentDiscussions.Offset + Model.RecentDiscussions.PageSize)"
                                   class="btn btn-ghost btn-sm">
                                    Next
                                </a>
                            }
                        </div>
                    }
                }
            }
        </div>

        <!-- Sidebar -->
        <aside id="sidebar" class="w-full lg:w-80 flex-shrink-0">
            @if (Model.ShowTrendingDiscussions)
            {
                <!-- Top Active Discussions Today -->
                <div class="sidebar-section">
                    <h3 class="sidebar-title">Trending Discussions</h3>
                    @if (Model.TopActiveDiscussions?.Items == null || Model.TopActiveDiscussions.Items.Length == 0)
                    {
                        <p class="sidebar-empty">No activity today yet</p>
                    }
                    else
                    {
                        <ul class="sidebar-list">
                            @foreach (var discussion in Model.TopActiveDiscussions.Items)
                            {
                                var discussionUrl = SnakkUrlHelper.Discussion(
                                    Model.Community,
                                    discussion.Hub.Slug,
                                    discussion.Space.Slug,
                                    $"{discussion.Slug}~{discussion.PublicId}");

                                <li>
                                    <a href="@discussionUrl" class="sidebar-link">
                                        <img src="@SnakkUrlHelper.UserAvatar(Model.ApiBaseUrl, discussion.Author.PublicId)"
                                             alt="@discussion.Author.DisplayName"
                                             loading="lazy"
                                             class="sidebar-avatar" />
                                        <span class="sidebar-link-content">
                                            <span class="sidebar-link-title" title="@discussion.Title">@discussion.Title</span>
                                            <span class="sidebar-link-meta">
                                                <span class="sidebar-badge">@discussion.PostCountToday posts today</span>
                                                <span data-popup-type="space"
                                                      data-popup-id="@discussion.Space.PublicId"
                                                      data-popup-name="@discussion.Space.Name">@discussion.Space.Name</span>
                                            </span>
                                        </span>
                                    </a>
                                </li>
                            }
                        </ul>
                    }
                </div>
            }

            @if (Model.ShowTrendingSpaces)
            {
                <!-- Top Trending Spaces Today -->
                <div class="sidebar-section">
                    <h3 class="sidebar-title">Trending Spaces</h3>
                    @if (Model.TopActiveSpaces?.Items == null || Model.TopActiveSpaces.Items.Length == 0)
                    {
                        <p class="sidebar-empty">No activity today yet</p>
                    }
                    else
                    {
                        <ul class="sidebar-list">
                            @foreach (var space in Model.TopActiveSpaces.Items)
                            {
                                var spaceUrl = SnakkUrlHelper.Space(Model.Community, space.Hub.Slug, space.Slug);

                                <li>
                                    <a href="@spaceUrl" class="sidebar-link">
                                        <img src="@SnakkUrlHelper.SpaceAvatar(Model.ApiBaseUrl, space.PublicId)"
                                             alt=""
                                             loading="lazy"
                                             class="sidebar-avatar" />
                                        <span class="sidebar-link-content">
                                            <span class="sidebar-link-title">@space.Name</span>
                                            <span class="sidebar-link-meta">
                                                <span class="sidebar-badge">@space.PostCountToday posts today</span>
                                                <span>@space.Hub.Name</span>
                                            </span>
                                        </span>
                                    </a>
                                </li>
                            }
                        </ul>
                    }
                </div>
            }

            @if (Model.ShowTrendingContributors)
            {
                <!-- Top Trending Contributors Today -->
                <div class="sidebar-section">
                    <h3 class="sidebar-title">Trending Contributors</h3>
                    @if (Model.TopContributors?.Items == null || Model.TopContributors.Items.Length == 0)
                    {
                        <p class="sidebar-empty">No contributors today yet</p>
                    }
                    else
                    {
                        <ul class="sidebar-list">
                            @foreach (var contributor in Model.TopContributors.Items)
                            {
                                <li>
                                    <span class="sidebar-link">
                                        <img src="@SnakkUrlHelper.UserAvatar(Model.ApiBaseUrl, contributor.PublicId)"
                                             alt="@contributor.DisplayName"
                                             loading="lazy"
                                             class="sidebar-avatar" />
                                        <span class="sidebar-link-content">
                                            <span class="sidebar-link-title"
                                                  data-popup-type="user"
                                                  data-popup-id="@contributor.PublicId"
                                                  data-popup-name="@contributor.DisplayName">@contributor.DisplayName</span>
                                            <span class="sidebar-link-meta">
                                                <span class="sidebar-badge">@contributor.PostCountToday posts today</span>
                                            </span>
                                        </span>
                                    </span>
                                </li>
                            }
                        </ul>
                    }
                </div>
            }
        </aside>
    </div>
</div>

@if (Model.PreferEndlessScroll && Model.RecentDiscussions?.HasMoreItems == true)
{
    <script>
    // Global configuration for JavaScript modules
    window.SnakkConfig = {
        apiBaseUrl: '@Model.ApiBaseUrl',
        communityPrefix: '@(Model.Community.IsDefaultCommunity ? "" : $"/c/{Model.Community.CommunitySlug}")',
        showCommunityInDiscussionList: @(Model.ShowCommunityInDiscussionList ? "true" : "false"),
        discussions: {
            pageSize: @Model.RecentDiscussions.PageSize,
            communityId: '@(Model.CommunityStats?.PublicId ?? "")',
            nextCursor: '@(Model.RecentDiscussions.NextCursor ?? "")',
            hasMoreItems: @(Model.RecentDiscussions.HasMoreItems ? "true" : "false")
        }
    };
    </script>
    <script src="~/js/utils.js"></script>
    <script src="~/js/frontpage-discussions.js"></script>
}

<script>
(function() {
    'use strict';

    // Only run on desktop (lg breakpoint)
    if (window.innerWidth < 1024) return;

    const sidebar = document.getElementById('sidebar');
    const nav = document.querySelector('nav');

    if (!sidebar || !nav) return;

    let sidebarOriginalTop = null;
    let navHeight = 0;
    let isSticky = false;

    function updateMeasurements() {
        navHeight = nav.offsetHeight;
        const sidebarRect = sidebar.getBoundingClientRect();
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;

        if (sidebarOriginalTop === null) {
            sidebarOriginalTop = sidebarRect.top + scrollTop;
        }

        // Set max-height to viewport minus nav height
        sidebar.style.maxHeight = `calc(100vh - ${navHeight}px)`;
    }

    function handleScroll() {
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const triggerPoint = sidebarOriginalTop - navHeight;

        if (scrollTop >= triggerPoint && !isSticky) {
            // Make sticky
            sidebar.classList.add('sidebar-sticky');
            sidebar.style.top = `${navHeight}px`;
            isSticky = true;
        } else if (scrollTop < triggerPoint && isSticky) {
            // Remove sticky
            sidebar.classList.remove('sidebar-sticky');
            sidebar.style.top = '';
            isSticky = false;
        }
    }

    // Initialize
    updateMeasurements();
    handleScroll();

    // Listen to scroll events (throttled)
    let scrollTimeout;
    window.addEventListener('scroll', function() {
        if (scrollTimeout) {
            window.cancelAnimationFrame(scrollTimeout);
        }
        scrollTimeout = window.requestAnimationFrame(function() {
            handleScroll();
        });
    }, { passive: true });

    // Update measurements on resize
    let resizeTimeout;
    window.addEventListener('resize', function() {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(function() {
            if (window.innerWidth >= 1024) {
                sidebarOriginalTop = null; // Reset to recalculate
                updateMeasurements();
                handleScroll();
            } else {
                // Remove sticky on mobile
                sidebar.classList.remove('sidebar-sticky');
                sidebar.style.top = '';
                sidebar.style.maxHeight = '';
                isSticky = false;
            }
        }, 100);
    });
})();

// Discussion Preview Feature
(function() {
    'use strict';

    const previewCache = new Map();

    function truncateText(text, maxLength) {
        if (text.length <= maxLength) return text;

        // Find the last space before maxLength
        let truncated = text.substring(0, maxLength);
        const lastSpace = truncated.lastIndexOf(' ');

        if (lastSpace > 0) {
            truncated = truncated.substring(0, lastSpace);
        }

        return truncated + '...';
    }

    async function fetchPreview(discussionId) {
        if (previewCache.has(discussionId)) {
            return previewCache.get(discussionId);
        }

        try {
            const response = await fetch(`@Model.ApiBaseUrl/discussions/${discussionId}/preview`);
            if (!response.ok) {
                throw new Error('Failed to fetch preview');
            }

            const data = await response.json();
            previewCache.set(discussionId, data.content);
            return data.content;
        } catch (error) {
            console.error('Error fetching preview:', error);
            return null;
        }
    }

    function togglePreview(button, previewDiv, discussionId) {
        const isCurrentlyVisible = !previewDiv.classList.contains('hidden');

        if (isCurrentlyVisible) {
            // Hide preview
            previewDiv.classList.add('hidden');
            button.classList.remove('active');
        } else {
            // Show preview
            const previewContent = previewDiv.querySelector('.preview-content');

            if (previewContent.textContent) {
                // Already loaded, just show
                previewDiv.classList.remove('hidden');
                button.classList.add('active');
            } else {
                // Load and show
                previewContent.innerHTML = '<span class="loading loading-spinner loading-sm"></span>';
                previewDiv.classList.remove('hidden');
                button.classList.add('active');

                fetchPreview(discussionId).then(content => {
                    if (content) {
                        const truncated = truncateText(content, 480);
                        previewContent.textContent = truncated;
                    } else {
                        previewContent.textContent = 'Failed to load preview';
                    }
                });
            }
        }
    }

    // Attach click handlers to all preview buttons
    document.querySelectorAll('.preview-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const discussionId = this.dataset.discussionId;
            const wrapper = this.closest('.topic-item-wrapper');
            const previewDiv = wrapper.nextElementSibling;

            if (previewDiv && previewDiv.classList.contains('discussion-preview')) {
                togglePreview(this, previewDiv, discussionId);
            }
        });
    });
})();
</script>
